"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("del"),t=require("gulp"),a=require("path"),r=require("commander"),n=require("single-line-log"),s=require("gulp-load-plugins"),i=require("vue-template-compiler"),p=require("preprocess"),o=require("shorthash2"),c=require("acorn-globals"),l=require("escodegen"),u=require("getmac"),f=require("fs-extra"),g=require("chokidar"),d=require("strip-json-comments"),h=require("vinyl"),m=require("gulp-strip-comments");function P(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var b=P(e),v=P(t),y=P(a),w=P(r),j=P(n),k=P(s),x=P(i),$=P(p),S=P(o),_=P(c),O=P(l),E=P(u),A=P(f),C=P(g),M=P(d),N=P(h),R=P(m);const{program:T}=w.default;T.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),T.parse(process.argv);const L={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json"}},q=L[T.type];if(!q)throw Error("小程序类型错");process.env.PACK_TYPE=T.type;const B=T.scope,F=function(e){return require.apply(null,arguments)}(y.default.resolve(B,"./projectToSubPackageConfig")),J=F.sourceCodePath||"src",W=F.wxResourcePath||`${J}/${q.globalObject}resource`,I=F.wxResourceAlias||"@wxResource",U=RegExp(I+"\\/","g"),D=F.uniRequireApiName||"__uniRequireWx",K=RegExp(D+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),H=F.uniImportWxssApiName||"__uniWxss",Y=RegExp(`(}|^|\\s|;)${H}\\s*{([^{}]+)}`,"g"),V=F.projectConfigPath||"";let z="dev";"production"===process.env.NODE_ENV&&(z="build");const Z="dist/"+z+"/mp-"+T.type;let G="dist/"+z+`/mp-${T.type}-pack`;T.plugin&&(G="dist/"+z+`/mp-${T.type}-pack-plugin`);var Q={pluginProcessFileTypes:F.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:q,program:T,cwd:B,projectToSubPackageConfig:F,wxResourcePath:W,wxResourceAlias:I,regExpWxResources:U,uniRequireApiName:D,regExpUniRequire:K,uniImportWxssApiName:H,regExpUniImportWxss:Y,configWxResourceKey:F.configWxResourceKey||"wxResource",env:z,base:Z,target:G,basePath:y.default.resolve(B,Z),subModePath:y.default.resolve(B,G,F.subPackagePath),targetPath:y.default.resolve(B,G),packIsSubpackage:{mode:!1},mpTypeNamespace:L,sourceCodePath:J,projectConfigPath:V};let X;const ee=j.default.stdout;var te={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){ee(e),clearTimeout(X),X=setTimeout(()=>{ee("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,a,r,n){a&&(a(t,r,n),t.childNodes?t.childNodes.forEach((t,r,n)=>{e(t,a,r,n)}):t.children&&t.children.forEach((t,r,n)=>{e(t,a,r,n)}))}};const{basePath:ae}=Q,{tryAgain:re}=te;v.default.task("clean:base",(async function e(t){try{await b.default([ae+"/**/*"],{force:!0})}catch(a){return void await re(async()=>{await e(t)})}t()}));const{subModePath:ne}=Q,{tryAgain:se}=te;v.default.task("clean:subModePath",(async function e(t){try{await b.default([ne+"/**/*"],{force:!0})}catch(a){return void await se(async()=>{await e(t)})}t()}));const{targetPath:ie}=Q,{tryAgain:pe}=te;v.default.task("clean:previewDist",(async function e(t){try{await b.default([ie+"/**/*"],{force:!0})}catch(a){return void await pe(async()=>{await e(t)})}t()}));const{compile:oe}=x.default;var ce=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=oe(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,a){if(!e.attrsMap)return"";e.attrsMap[t]=a}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:a,attrsMap:r,children:n=[]}=t;return e+=this.writeOpenTag(a,r),e+=this.render(n),e+=this.writeCloseTag(a)},t)}writeOpenTag(e,t){if(t){const a=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${a.length>0?" "+a.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:le,mpTypeNamespace:ue}=Q,{deepFind:fe}=te,ge=Object.keys(ue).map(e=>ue[e].directivePrefix),de=Object.keys(ue).map(e=>ue[e].html),he=RegExp(`^(${ge.join("|")})`),me=RegExp(`\\.(${de.join("|")})$`,"i");var Pe=function(e,t){if(t.relative.match(me)){const t=new ce(e);return fe(t.topNode,e=>{if(!e.tag||3===e.type)return;const a=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&a&&!a.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",a+" ");const r=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&r&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",r);const n=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&n&&t.setAttr(e,"src",n.replace(me,"."+le.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(he)){const a=t.replace(he,le.directivePrefix);e.attrsMap[a]=e.attrsMap[t],a!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:be,mpTypeNamespace:ve}=Q,ye=Object.keys(ve).map(e=>ve[e].css),we=RegExp(`\\.(${ye.join("|")})$`,"i");var je=function(e,{relative:t}){return t.match(we)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(we,"."+be.css)}'`}))),e};var ke=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:xe}=$.default;var $e=function(e,{relative:t}){if(t.match(/\.js$/i))try{return xe(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:Se}=Q,{preprocess:_e}=$.default;var Oe=function(e,{relative:t}){if(t.match(RegExp(`.${Se.css}$`,"i")))try{return _e(e,process.env,{type:"css"})}catch(t){return console.log(Se.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:Ee}=Q,{preprocess:Ae}=$.default;var Ce=function(e,{relative:t}){if(t.match(RegExp(`.${Ee.html}$`,"i")))try{return Ae(e,process.env,{type:"html"})}catch(t){return console.log(Ee.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:Me,currentNamespace:Ne}=Q,Re=(process,new Set(Object.keys(Me).map(e=>Me[e].globalObject)));var Te={mixinsEnvCode:function(e){let t="";return Re.forEach(e=>{Ne.globalObject!==e&&(t+=`var ${e} = ${Ne.globalObject};\n`)}),t}};const{mixinsEnvCode:Le}=Te;var qe=function(e,{relative:t}){return t.match(/\.js$/i)?Le()+e:e};const{projectToSubPackageConfig:Be,basePath:Fe}=Q;const Je=S.default(Be.subPackagePath+(0,E.default)()+Math.random()+Date.now()),We={library:`webpackJsonp_${Be.subPackagePath}_${Je}`,reference:"webpackJsonp"};var Ie={htmlMixinPlugin:Pe,cssMixinPlugin:je,polyfillPlugin:ke,jsPreProcessPlugin:$e,cssPreProcessPlugin:Oe,htmlPreProcessPlugin:Ce,jsMixinPlugin:qe,setLibrary:function(e,{fromAbsolute:t},a,r={}){r={...We,...r};let n=!1;if(t.startsWith(Fe)&&".js"===y.default.extname(t)){const t=_.default.parse(e),a=_.default(t);for(const{name:e,nodes:t}of a)if("global"===e)for(const{parents:e}of t)for(const t of e){const{type:e,property:{type:a,value:s}={}}=t;"MemberExpression"===e&&"Literal"===a&&s===r.reference&&(t.property.value=r.library,n=!0)}if(n){const e="production"===process.env.NODE_ENV?O.default.FORMAT_MINIFY:O.default.FORMAT_DEFAULTS;return O.default.generate(t,{format:e})}}return e}};const{projectToSubPackageConfig:Ue,targetPath:De}=Q,Ke=y.default;(!Ue.plugins||!Ue.plugins instanceof Array)&&(Ue.plugins=[]);var He={runPlugins:function(e){return function(t){const{plugins:a}=Ue;if(a&&!(!a instanceof Array))return a.reduce((t,a)=>{if("string"==typeof a&&(a=Ie[a]),"function"!=typeof a)return t;const r=Ke.resolve(e,this.file.relative),n={relative:r.replace(RegExp("^"+De.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:r,fromAbsolute:this.file.path,fromRelative:this.file.relative};this.removeAfterAdd=function(e){!function(e){A.default.existsSync(e)&&A.default.removeSync(e);const t=C.default.watch(e);t.on("add",(function(){A.default.removeSync(e),t.close()}))}(e=e||r)};const s=a.call(this,t,n,Ie);return null==s?t:s},t)}}};const Ye=k.default(),{cwd:Ve,projectToSubPackageConfig:ze,target:Ze,env:Ge,pluginProcessFileTypes:Qe,sourceCodePath:Xe}=Q,{writeLastLine:et}=te,{runPlugins:tt}=He;v.default.task("watch:pluginJson",(function(){const e=Ye.filter(Qe.map(e=>"**/*."+e),{restore:!0});return v.default.src(Xe+"/plugin.json",{allowEmpty:!0,cwd:Ve}).pipe(Ye.if("dev"===Ge,Ye.watch(Xe+"/plugin.json",{cwd:Ve},(function(e){et("处理"+e.relative+"......")})))).pipe(e).pipe(Ye.replace(/[\s\S]*/,tt(y.default.resolve(Ve,Ze+"/"+ze.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Ze+"/"+ze.subPackagePath,{cwd:Ve}))}));const at=k.default(),{cwd:rt,target:nt,env:st,targetPath:it,pluginProcessFileTypes:pt,currentNamespace:ot,projectConfigPath:ct}=Q,{writeLastLine:lt}=te,{runPlugins:ut}=He;v.default.task("watch:projectConfigJson",(function(){const e=at.filter(pt.map(e=>"**/*."+e),{restore:!0});return v.default.src(`${ct?ct+"/":""}${ot.projectConfig}`,{allowEmpty:!0,cwd:rt}).pipe(at.if("dev"===st,at.watch(`${ct?ct+"/":""}${ot.projectConfig}`,{cwd:rt},(function(e){lt("处理"+e.relative+"......")})))).pipe(e).pipe(at.replace(/[\s\S]*/,ut(it),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(nt,{cwd:rt}))}));const{runPlugins:ft}=He,{program:gt,cwd:dt,projectToSubPackageConfig:ht,subModePath:mt,targetPath:Pt,packIsSubpackage:bt,currentNamespace:vt,target:yt}=Q;var wt=function(){if(gt.plugin)return;const e=y.default.resolve(dt,ht[vt.mainMpPath]+"/app.js");if(A.default.existsSync(e)){const t=A.default.readFileSync(e,"utf8");let a=`./${ht.subPackagePath}/`,r="app.js";mt===Pt&&(r="uni-bootstrap.js");let n=`require('${a}${r}');\n`;(bt.mode||gt.plugin)&&(n="");const s=new N.default({cwd:dt,base:y.default.resolve(dt,ht[vt.mainMpPath]),path:e});A.default.outputFileSync(Pt+"/"+s.relative,ft(y.default.resolve(dt,yt+(gt.plugin?"/miniprogram":""))).call({file:s},n+t))}};const jt=k.default(),{program:kt,cwd:xt,projectToSubPackageConfig:$t,configWxResourceKey:St,base:_t,packIsSubpackage:Ot,currentNamespace:Et,sourceCodePath:At}=Q,{writeLastLine:Ct}=te;var Mt=function(e){return Ct("处理app.json......"),jt.replace(/[\s\S]+/,(function(t){if(kt.plugin&&"mainAppJson"===e)return t;Ot.mode=!1;let a,r,n,s={};({pagesJson(){try{a=JSON.parse(M.default(t))}catch(e){a={}}},baseAppJson(){try{r=JSON.parse(t)}catch(e){r={}}},mainAppJson(){try{n=JSON.parse(t)}catch(e){n={}}}})[e]();try{a||(a=JSON.parse(M.default(A.default.readFileSync(y.default.resolve(xt,At+"/pages.json"),"utf8"))))}catch(e){a={}}try{r||(r=JSON.parse(A.default.readFileSync(y.default.resolve(xt,_t+"/app.json"),"utf8")))}catch(e){r={}}try{n||(n=JSON.parse(A.default.readFileSync(y.default.resolve(xt,$t[Et.mainMpPath]+"/app.json"),"utf8")))}catch(e){n={}}function i(e){return $t.subPackagePath+($t.subPackagePath?"/":"")+e}if(n.subpackages&&!n.subPackages&&(n.subPackages=n.subpackages),n.subPackages){let e=n.subPackages.find(e=>e.root===$t.subPackagePath);if(e){Ot.mode=!0;let t=[...a[St]&&a[St].pages||[],...r.pages||[]];return r.subPackages&&r.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[St]&&a[St].subPackages&&a[St].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,wt.call(this),delete r.pages,delete r.subPackages,JSON.stringify({...r,...n},null,2)}}r.pages&&r.pages.forEach((e,t)=>{r.pages[t]=i(e)}),r.subPackages&&r.subPackages.forEach(e=>{e.root=i(e.root)}),a[St]&&(a[St].pages&&a[St].pages.forEach((e,t)=>{a[St].pages[t]=i(e)}),a[St].subPackages&&a[St].subPackages.forEach(e=>{e.root=i(e.root)})),r.tabBar&&r.tabBar.list&&r.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...n},s)=>{r.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:a?i(a):"",...n}}),s={...r,...n},s.pages=Array.from(new Set([...a.indexPage?[i(a.indexPage)]:[],...n.pages||[],...r.pages||[],...a[St]&&a[St].pages||[]]));let p=[],o={},c={};function l(e){e.forEach(e=>{o[e.root]=o[e.root]?Array.from(new Set([...o[e.root],...e.pages])):e.pages,e.name&&(c[e.root]=e.name)})}l(a[St]&&a[St].subPackages||[]),l(r.subPackages||[]),l(n.subPackages||[]);for(let e in o){const t={root:e,pages:o[e]};c[e]&&(t.name=c[e]),p.push(t)}if(s.subPackages=[...p],r.usingComponents){for(let e in r.usingComponents)r.usingComponents[e]="/"+$t.subPackagePath+r.usingComponents[e];s.usingComponents={...s.usingComponents||{},...r.usingComponents}}return wt.call(this),"toutiao"===kt.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const Nt=k.default(),{cwd:Rt,target:Tt,env:Lt,targetPath:qt,pluginProcessFileTypes:Bt,sourceCodePath:Ft}=Q,{writeLastLine:Jt}=te,{runPlugins:Wt}=He;v.default.task("watch:pagesJson",(function(){const e=Nt.filter(Bt.map(e=>"**/*."+e),{restore:!0});return v.default.src(Ft+"/pages.json",{allowEmpty:!0,cwd:Rt}).pipe(Nt.if("dev"===Lt,Nt.watch(Ft+"/pages.json",{cwd:Rt},(function(e){Jt("处理"+e.relative+"......")})))).pipe(Mt("pagesJson")).pipe(Nt.rename("app.json")).pipe(e).pipe(Nt.replace(/[\s\S]*/,Wt(qt),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Tt,{cwd:Rt}))}));const It=k.default(),{cwd:Ut,target:Dt,env:Kt,base:Ht,targetPath:Yt,pluginProcessFileTypes:Vt}=Q,{writeLastLine:zt}=te,{runPlugins:Zt}=He;v.default.task("watch:baseAppJson",(function(){const e=It.filter(Vt.map(e=>`${Ht}/**/*.${e}`),{restore:!0});return v.default.src(Ht+"/app.json",{allowEmpty:!0,cwd:Ut}).pipe(It.if("dev"===Kt,It.watch(Ht+"/app.json",{cwd:Ut},(function(e){zt("处理"+e.relative+"......")})))).pipe(Mt("baseAppJson")).pipe(e).pipe(It.replace(/[\s\S]*/,Zt(Yt),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Dt,{cwd:Ut}))}));const Gt=k.default(),{cwd:Qt,target:Xt,env:ea,projectToSubPackageConfig:ta,program:aa,currentNamespace:ra,pluginProcessFileTypes:na}=Q,{writeLastLine:sa}=te,{runPlugins:ia}=He;v.default.task("watch:mainAppJson",(function(){const e=ta[ra.mainMpPath],t=Gt.filter(na.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src(e+"/app.json",{allowEmpty:!0,cwd:Qt}).pipe(Gt.if("dev"===ea,Gt.watch(e+"/app.json",{cwd:Qt},(function(e){sa("处理"+e.relative+"......")})))).pipe(Mt("mainAppJson")).pipe(t).pipe(Gt.replace(/[\s\S]*/,ia(y.default.resolve(Qt,Xt+(aa.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(v.default.dest(Xt+(aa.plugin?"/miniprogram":""),{cwd:Qt}))}));const pa=k.default(),{cwd:oa,target:ca,env:la,projectToSubPackageConfig:ua,program:fa,basePath:ga,currentNamespace:da,mpTypeNamespace:ha,pluginProcessFileTypes:ma}=Q,{writeLastLine:Pa}=te,{runPlugins:ba}=He;v.default.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=ua[da.mainMpPath];const t=Object.keys(ha).map(t=>`${e}/app.${ha[t].css}`),a=pa.filter([...t],{restore:!0}),r=pa.filter([e+"/app.js"],{restore:!0}),n=pa.filter(ma.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/app.js",...t],{allowEmpty:!0,cwd:oa}).pipe(pa.if("dev"===la,pa.watch([e+"/app.js",`${e}/app.${da.css}`],{cwd:oa},(function(e){Pa("处理"+e.relative+"......")})))).pipe(r).pipe(pa.replace(/^/,(function(e){return"require('./uni-bootstrap.js');\n"}),{skipBinary:!1})).pipe(r.restore).pipe(a).pipe(pa.replace(/^/,(function(e){return A.default.readFileSync(`${ga}/app.${da.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(pa.rename((function(e){e.extname="."+da.css}))).pipe(a.restore).pipe(n).pipe(pa.replace(/[\s\S]*/,ba(y.default.resolve(oa,ca+(fa.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(n.restore).pipe(v.default.dest(ca+(fa.plugin?"/miniprogram":""),{cwd:oa}))}));const va=k.default(),{cwd:ya,target:wa,env:ja,projectToSubPackageConfig:ka,base:xa,wxResourcePath:$a,currentNamespace:Sa,mpTypeNamespace:_a,pluginProcessFileTypes:Oa}=Q,{writeLastLine:Ea}=te,{runPlugins:Aa}=He;v.default.task("watch:mainWeixinMpPackPath",(function(){const e=ka[Sa.mainMpPath],t=e+"/"+ka.subPackagePath,a=wa+"/"+ka.subPackagePath,r=[],n=[],s=new Set,i=new Set;Object.keys(_a).forEach(e=>{r.push(`${t}/**/*.${_a[e].css}`),n.push(`${t}/**/*.${_a[e].html}`),s.add("."+_a[e].css),i.add("."+_a[e].html)});const p=va.filter([...n],{restore:!0}),o=va.filter([...r],{restore:!0}),c=(va.filter([t+"/**/*.js"],{restore:!0}),va.filter(Oa.map(e=>`${t}/**/*.${e}`),{restore:!0}));return v.default.src([t,t+"/**/*","!"+t+"/pack.config.js"],{allowEmpty:!0,cwd:ya}).pipe(va.if("dev"===ja,va.watch([t,t+"/**/*","!/"+t+"/pack.config.js"],{cwd:ya},(function(e){Ea("处理"+e.relative+"......")})))).pipe(va.filter((function(t){if(t.relative!==Sa.projectConfig&&!function(e){const t=ka[Sa.mainMpPath]+"/"+ka.subPackagePath;return A.default.existsSync(e.path.replace(y.default.resolve(ya,t),y.default.resolve(ya,xa)))?["ext.json",Sa.projectConfig].indexOf(e.relative)>-1&&ka.mergePack&&""===ka.subPackagePath:!A.default.existsSync(e.path.replace(y.default.resolve(ya,t),y.default.resolve(ya,$a)))}(t))return!1;if("unlink"===t.event){try{let a=t.path;const r=RegExp(t.extname+"$","i");s.has(t.extname)&&(a=a.replace(r,"."+Sa.css)),i.has(t.extname)&&(a=a.replace(r,"."+Sa.html)),b.default.sync([a.replace(y.default.resolve(ya,e),y.default.resolve(ya,wa))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(va.rename((function(e){e.extname="."+Sa.html}))).pipe(p.restore).pipe(o).pipe(va.rename((function(e){e.extname="."+Sa.css}))).pipe(o.restore).pipe(c).pipe(va.replace(/[\s\S]*/,Aa(y.default.resolve(ya,a)),{skipBinary:!1})).pipe(c.restore).pipe(v.default.dest(a,{cwd:ya}))}));const Ca=k.default(),{cwd:Ma,target:Na,env:Ra,projectToSubPackageConfig:Ta,subModePath:La,targetPath:qa,program:Ba,packIsSubpackage:Fa,currentNamespace:Ja,mpTypeNamespace:Wa,pluginProcessFileTypes:Ia}=Q,{writeLastLine:Ua}=te,{runPlugins:Da}=He;v.default.task("watch:mainWeixinMp",(function(){const e=Ta[Ja.mainMpPath],t=e+"/"+Ta.subPackagePath,a=[],r=[],n=new Set,s=new Set;Object.keys(Wa).forEach(t=>{a.push(`${e}/**/*.${Wa[t].css}`),r.push(`${e}/**/*.${Wa[t].html}`),n.add("."+Wa[t].css),s.add("."+Wa[t].html)});const i=Ca.filter([e+"/app.js"],{restore:!0}),p=(Ca.filter([e+"/**/*.js"],{restore:!0}),Ca.filter([...r],{restore:!0})),o=Ca.filter([...a],{restore:!0}),c=Ca.filter(Ia.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Ja.html}___jb_tmp___`,"!"+e+`/**/*.${Ja.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+t+"/**/*"],{base:y.default.resolve(Ma,e),allowEmpty:!0,cwd:Ma}).pipe(Ca.if("dev"===Ra,Ca.watch([e+"/**/*","!/"+e+"/app.json","!/"+t+"/**/*"],{cwd:Ma},(function(e){e.relative.match(/.json/),Ua("处理"+e.relative+"......")})))).pipe(Ca.filter((function(t){if("unlink"===t.event){try{let a=t.path;const r=RegExp(t.extname+"$","i");n.has(t.extname)&&(a=a.replace(r,"."+Ja.css)),s.has(t.extname)&&(a=a.replace(r,"."+Ja.html)),b.default.sync([a.replace(y.default.resolve(Ma,e),y.default.resolve(Ma,Na))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(Ca.replace(/[\s\S]*/,(function(e){if(Fa.mode||Ba.plugin)return e;let t=`./${Ta.subPackagePath}/`,a="app.js";return La===qa&&(a="uni-bootstrap.js"),e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}${a}');\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(p).pipe(Ca.rename((function(e){e.extname="."+Ja.html}))).pipe(p.restore).pipe(o).pipe(Ca.rename((function(e){e.extname="."+Ja.css}))).pipe(o.restore).pipe(c).pipe(Ca.replace(/[\s\S]*/,Da(y.default.resolve(Ma,Na+(Ba.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(c.restore).pipe(v.default.dest(Na+(Ba.plugin?"/miniprogram":""),{cwd:Ma}))}));var Ka={fakeUniBootstrap:function(e,t,a,r){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:r}),globalObject.onAppHide&&globalObject.onAppShow||(a="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==a||globalObject.onAppRoute||(a="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var n=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?n.__packInit[s]=e[s]:function(t){n.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==a){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(r){"top"!==a&&0!==("/"+r.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=r.path})),globalObject.onAppHide((function(r){if("top"===a)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,r);var n=getCurrentPages();return 0===("/"+(null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===a&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===a&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(r){if("top"!==a){var n=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var a=getCurrentPages(),r=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+r).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof n)return n.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const{basePath:Ha,targetPath:Ya,subModePath:Va,currentNamespace:za}=Q;var Za=function(e){const t=y.default.resolve(Ya,"app.js"),a=y.default.resolve(Ya,"app."+za.css),r=e.path.replace(Ha,Va);return t===r||a===r};const Ga=k.default(),{regExpWxResources:Qa,regExpUniRequire:Xa}=Q,{getLevelPath:er,getLevel:tr}=te;var ar={uniRequireWxResource:function(){return Ga.replace(/[\s\S]*/,(function(e,t){const a=["var __uniPackNativeRequireInject={};\n"],r=tr(this.file.relative);return e=e.replace(Xa,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(Qa,er(r))})`);const n=t.replace(Qa,er(r)),s=`__uniPackNativeRequireInject[${n}] = require(${n});\n`;return 0>a.indexOf(s)&&a.push(s),`__uniPackNativeRequireInject[${n}]`}),a[1]?`${a.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:rr,regExpWxResources:nr,wxResourceAlias:sr}=Q,{getLevelPath:ir,getLevel:pr}=te;var or=function(e,t){const a=pr(t);return"@import "+`"${sr}/common/main.${rr.css}";`.replace(nr,ir(a))+("\n"+e)};const cr=k.default(),{fakeUniBootstrapName:lr,fakeUniBootstrap:ur}=Ka,{cwd:fr,env:gr,program:dr,basePath:hr,targetPath:mr,subModePath:Pr,base:br,regExpUniRequire:vr,regExpWxResources:yr,regExpUniImportWxss:wr,currentNamespace:jr,mpTypeNamespace:kr,pluginProcessFileTypes:xr,sourceCodePath:$r,projectToSubPackageConfig:Sr}=Q,_r=process.env.PACK_TYPE,{writeLastLine:Or,getLevel:Er,getLevelPath:Ar,deepFind:Cr}=te,{uniRequireWxResource:Mr}=ar,{runPlugins:Nr}=He,Rr=Object.keys(kr).map(e=>kr[e].css),Tr=new Set(Rr);v.default.task("subMode:createUniSubPackage",(function(){A.default.mkdirsSync(hr);const e=cr.filter(br+"/**/*.js",{restore:!0}),t=cr.filter([br+"/common/vendor.js"],{restore:!0}),a=cr.filter([br+"/common/main.js"],{restore:!0}),r=cr.filter(xr.map(e=>`${br}/**/*.${e}`),{restore:!0}),n=cr.filter([br+"/**/*.js","!"+br+"/app.js","!"+br+"/uni-bootstrap.js","!"+br+"/common/vendor.js","!"+br+"/common/main.js","!"+br+"/common/runtime.js"],{restore:!0}),s=cr.filter([`${br}/**/*.${jr.css}`,`!${br}/app.${jr.css}`,`!${br}/common/main.${jr.css}`],{restore:!0}),i=cr.filter([`${br}/**/*.${jr.css}`,`!${br}/app.${jr.css}`],{restore:!0}),p=cr.filter([br+"/**/*.json"],{restore:!0}),o=cr.filter([`${br}/**/*.${jr.html}`],{restore:!0});return v.default.src([br+"/**","!"+br+"/app.json",br+"/app.js",`${br}/app.${jr.css}`],{allowEmpty:!0,cwd:fr}).pipe(cr.if("dev"===gr,cr.watch([br+"/**/*","!/"+br+"/app.json"],{cwd:fr},(function(e){Or("处理"+e.relative+"......")})))).pipe(cr.filter((function(e){if(function(e){if(0>["ext.json",jr.projectConfig].indexOf(e.relative))return!1;if(Sr.mergePack&&""===Sr.subPackagePath){if(A.default.existsSync(y.default.resolve(fr,Sr[jr.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");Tr.has(e.extname.substr(1))&&(t=t.replace(a,"."+jr.css)),b.default.sync([t.replace(hr,y.default.resolve(fr,Pr))],{force:!0})}catch(e){}return!1}return!Za(e)||".js"===e.extname&&(e.basename="uni-bootstrap.js",!0)}))).pipe(o).pipe(cr.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(jr.html+"$","i"),jr.css),a=this.file.relative.replace(RegExp(jr.html+"$","i"),jr.css);A.default.existsSync(t)||A.default.outputFileSync(y.default.resolve(fr,Pr,a),or("",a));const r=new ce(e);let n=0;return Cr(r.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(vr,(t,a,r,s)=>{const i=Er(this.file.relative),p=a.replace(yr,Ar(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],n=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),n?r.render():e}),{skipBinary:!1})).pipe(o.restore).pipe(t).pipe(cr.replace(/^/,(function(e){return dr.plugin?`var App=function(packInit){};${jr.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${lr}=${(""+ur).replace(/globalObject/g,jr.globalObject)};${lr}(packInit,__packConfig.packPath,__packConfig.appMode,'${_r}');};`}),{skipBinary:!1})).pipe(t.restore).pipe(e).pipe(R.default()).pipe(Mr()).pipe(e.restore).pipe(a).pipe(cr.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(cr.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(a.restore).pipe(n).pipe(cr.replace(/^/,(function(e){if(A.default.existsSync(y.default.resolve(fr,$r,this.file.relative)))return e;let t=Ar(Er(this.file.relative)),a="app.js";return Pr===mr&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(n.restore).pipe(p).pipe(cr.replace(/[\s\S]*/,(function(e){if(!A.default.existsSync(y.default.resolve(fr,$r,this.file.relative.replace(/json$/,"vue")))&&!A.default.existsSync(y.default.resolve(fr,$r,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Ar(Er(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(p.restore).pipe(i).pipe(cr.stripCssComments()).pipe(cr.replace(wr,(function(e,t,a){let r="",n=Er(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const a=RegExp(`(${Rr.join("|")})(['"])$`);t=t.replace(a,jr.css+"$2"),r+=`@import ${t.replace(yr,Ar(n))};\n`})),t+r}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(cr.stripCssComments()).pipe(cr.replace(/^[\s\S]*$/,(function(e){return Pr===mr?e:or(e,this.file.relative)}),{skipBinary:!1})).pipe(s.restore).pipe(r).pipe(cr.replace(/[\s\S]*/,Nr(Pr),{skipBinary:!1})).pipe(r.restore).pipe(v.default.dest(Pr,{cwd:fr}))}));const Lr=k.default(),{cwd:qr,env:Br,targetPath:Fr,subModePath:Jr,regExpWxResources:Wr,regExpUniImportWxss:Ir,wxResourcePath:Ur,currentNamespace:Dr,mpTypeNamespace:Kr,pluginProcessFileTypes:Hr,projectToSubPackageConfig:Yr}=Q,{writeLastLine:Vr,getLevel:zr,getLevelPath:Zr}=te,{uniRequireWxResource:Gr}=ar,{runPlugins:Qr}=He,Xr=[],en=[],tn=[],an=new Set,rn=new Set;Object.keys(Kr).forEach(e=>{Xr.push(Kr[e].css),en.push(`${Ur}/**/*.${Kr[e].css}`),tn.push(`${Ur}/**/*.${Kr[e].html}`),an.add("."+Kr[e].css),rn.add("."+Kr[e].html)}),v.default.task("subMode:copyWxResource",(function(){const e=Yr[Dr.mainMpPath],t=Lr.filter([Ur+"/**/*.js"],{restore:!0}),a=Lr.filter([...en],{restore:!0}),r=Lr.filter([...tn],{restore:!0}),n=Lr.filter(Hr.map(e=>`${Ur}/**/*${e}`),{restore:!0});return v.default.src([Ur+"/**",Ur,`!${e}/app.json`],{allowEmpty:!0,cwd:qr}).pipe(Lr.if("dev"===Br,Lr.watch([Ur+"/**",Ur,`!/${e}/app.json`,`!/${Ur}/**/*.*___jb_tmp___`],{cwd:qr},(function(e){Vr("处理"+e.relative+"......")})))).pipe(t).pipe(Lr.replace(/^/,(function(e){let t=Zr(zr(this.file.relative)),a="app.js";return Jr===Fr&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(R.default()).pipe(Gr()).pipe(t.restore).pipe(a).pipe(Lr.stripCssComments()).pipe(Lr.replace(Ir,(function(e,t,a){let r="";zr(this.file.relative);return t+r}),{skipBinary:!1})).pipe(Lr.replace(/^[\s\S]*$/,(function(e){return Jr===Fr?e:or(e,this.file.relative)}),{skipBinary:!1})).pipe(Lr.rename((function(e){e.extname="."+Dr.css}))).pipe(a.restore).pipe(r).pipe(Lr.rename((function(e){e.extname="."+Dr.html}))).pipe(r.restore).pipe(Lr.filter((function(e){if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");an.has(e.extname)&&(t=t.replace(a,"."+Dr.css)),rn.has(e.extname)&&(t=t.replace(a,"."+Dr.html)),b.default.sync([t.replace(y.default.resolve(qr,Ur),y.default.resolve(qr,Jr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(n).pipe(Lr.replace(/[\s\S]*/,Qr(Jr),{skipBinary:!1})).pipe(n.restore).pipe(v.default.dest(Jr,{cwd:qr}))}));const nn=k.default(),{cwd:sn,target:pn,env:on,projectToSubPackageConfig:cn,currentNamespace:ln,mpTypeNamespace:un,pluginProcessFileTypes:fn}=Q,{writeLastLine:gn}=te,{runPlugins:dn}=He;v.default.task("watch:native",(function(){const e=cn[ln.mainMpPath],t=[],a=[],r=new Set,n=new Set;Object.keys(un).forEach(s=>{t.push(`${e}/**/*.${un[s].css}`),a.push(`${e}/**/*.${un[s].html}`),r.add("."+un[s].css),n.add("."+un[s].html)});nn.filter([e+"/**/*.js"],{restore:!0});const s=nn.filter([...a],{restore:!0}),i=nn.filter([...t],{restore:!0}),p=nn.filter(fn.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/**/*","!"+e+"/app.json"],{base:y.default.resolve(sn,e),allowEmpty:!0,cwd:sn}).pipe(nn.if("dev"===on,nn.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:sn},(function(e){gn("处理"+e.relative+"......")})))).pipe(nn.filter((function(t){if("unlink"===t.event){try{let a=t.path;const s=RegExp(t.extname+"$","i");r.has(t.extname)&&(a=a.replace(s,"."+ln.css)),n.has(t.extname)&&(a=a.replace(s,"."+ln.html)),b.default.sync([a.replace(y.default.resolve(sn,e),y.default.resolve(sn,pn))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(s).pipe(nn.rename((function(e){e.extname="."+ln.html}))).pipe(s.restore).pipe(i).pipe(nn.rename((function(e){e.extname="."+ln.css}))).pipe(i.restore).pipe(p).pipe(nn.replace(/[\s\S]*/,dn(y.default.resolve(sn,pn)),{skipBinary:!1})).pipe(p.restore).pipe(v.default.dest(pn,{cwd:sn}))}));const{cwd:hn,env:mn,targetPath:Pn,subModePath:bn,projectToSubPackageConfig:vn,program:yn,currentNamespace:wn}=Q,{tryAgain:jn}=te;async function kn(e){let t=y.default.resolve(hn,vn[wn.mainMpPath],"app.js");await A.default.exists(t)||await A.default.outputFile(t,"App({});"),e()}v.default.task("mpWxSubMode",v.default.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(yn.plugin||yn.native)t();else{try{let e={packPath:(vn.subPackagePath?"/":"")+vn.subPackagePath,appMode:vn.appMode};await A.default.outputFile(bn+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await jn(async()=>{await e(t)})}t()}}),function(){let e=[kn,"subMode:createUniSubPackage","subMode:copyWxResource",...yn.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...vn.mergePack?["watch:mainWeixinMpPackPath"]:[],...bn===Pn?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return yn.native&&(e=[kn,"watch:mainAppJson","watch:native"]),"build"===mn?v.default.series.apply(this,e):v.default.parallel.apply(this,e)}(),(function(e){e(),"build"===mn&&process.exit()})));const{cwd:xn,basePath:$n,base:Sn,program:_n}=Q;v.default.task("startToPackServe",v.default.series((async function(e){_n.native||await A.default.exists($n)||await A.default.mkdirs($n),e()}),"clean:base",(function(e){_n.native?e():v.default.watch(Sn+"/app.json",{events:["all"],cwd:xn},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});exports.default={};
