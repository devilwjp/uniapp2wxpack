"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("del"),t=require("gulp"),a=require("path"),n=require("commander"),r=require("single-line-log"),s=require("gulp-load-plugins"),i=require("vue-template-compiler"),p=require("preprocess"),o=require("shorthash2"),c=require("acorn-globals"),l=require("escodegen"),u=require("getmac"),f=require("fs-extra"),g=require("chokidar"),d=require("strip-json-comments"),h=require("vinyl"),m=require("gulp-strip-comments");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var P=b(e),y=b(t),v=b(a),w=b(n),j=b(r),k=b(s),x=b(i),$=b(p),S=b(o),_=b(c),O=b(l),E=b(u),M=b(f),C=b(g),A=b(d),R=b(h),N=b(m);const{program:T}=w.default;T.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式").option("--gulpfile","").option("--cwd",""),T.parse(process.argv);const L={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json",pluginConfig:"plugin.json",webpackGlobal:"global"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json",webpackGlobal:"global"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json",webpackGlobal:"global"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json",pluginConfig:"plugin.json",webpackGlobal:"my"}},q=L[T.type];if(!q)throw Error("小程序类型错");process.env.PACK_TYPE=T.type;const B=T.scope,F=function(e){return require.apply(null,arguments)}(v.default.resolve(B,"./projectToSubPackageConfig")),J=F.sourceCodePath||"src",W=F.wxResourcePath||`${J}/${q.globalObject}resource`,I=F.wxResourceAlias||"@wxResource",U=RegExp(I+"\\/","g"),D=F.uniRequireApiName||"__uniRequireWx",K=RegExp(D+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),H=F.uniImportWxssApiName||"__uniWxss",Y=RegExp(`(}|^|\\s|;)${H}\\s*{([^{}]+)}`,"g"),G=F.projectConfigPath||"",V=F.pluginTypeMiniProgramRoot||"miniprogram";let z="dev";"production"===process.env.NODE_ENV&&(z="build");const Z="dist/"+z+"/mp-"+T.type;let Q="dist/"+z+`/mp-${T.type}-pack`;T.plugin&&(Q="dist/"+z+`/mp-${T.type}-pack-plugin`);var X={pluginProcessFileTypes:F.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:q,program:T,cwd:B,projectToSubPackageConfig:F,wxResourcePath:W,wxResourceAlias:I,regExpWxResources:U,uniRequireApiName:D,regExpUniRequire:K,uniImportWxssApiName:H,regExpUniImportWxss:Y,configWxResourceKey:F.configWxResourceKey||"wxResource",env:z,base:Z,target:Q,basePath:v.default.resolve(B,Z),subModePath:v.default.resolve(B,Q,F.subPackagePath),targetPath:v.default.resolve(B,Q),packIsSubpackage:{mode:!1},mpTypeNamespace:L,sourceCodePath:J,projectConfigPath:G,pluginTypeMiniProgramRoot:V};let ee;const te=j.default.stdout;var ae={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){te(e),clearTimeout(ee),ee=setTimeout(()=>{te("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,a,n,r){a&&(a(t,n,r),t.childNodes?t.childNodes.forEach((t,n,r)=>{e(t,a,n,r)}):t.children&&t.children.forEach((t,n,r)=>{e(t,a,n,r)}))}};const{basePath:ne}=X,{tryAgain:re}=ae;y.default.task("clean:base",(async function e(t){try{await P.default([ne+"/**/*"],{force:!0})}catch(a){return void await re(async()=>{await e(t)})}t()}));const{subModePath:se}=X,{tryAgain:ie}=ae;y.default.task("clean:subModePath",(async function e(t){try{await P.default([se+"/**/*"],{force:!0})}catch(a){return void await ie(async()=>{await e(t)})}t()}));const{targetPath:pe}=X,{tryAgain:oe}=ae;y.default.task("clean:previewDist",(async function e(t){try{await P.default([pe+"/**/*"],{force:!0})}catch(a){return void await oe(async()=>{await e(t)})}t()}));const{compile:ce}=x.default;var le=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=ce(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,a){if(!e.attrsMap)return"";e.attrsMap[t]=a}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:a,attrsMap:n,children:r=[]}=t;return e+=this.writeOpenTag(a,n),e+=this.render(r),e+=this.writeCloseTag(a)},t)}writeOpenTag(e,t){if(t){const a=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${a.length>0?" "+a.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:ue,mpTypeNamespace:fe}=X,{deepFind:ge}=ae,de=Object.keys(fe).map(e=>fe[e].directivePrefix),he=Object.keys(fe).map(e=>fe[e].html),me=RegExp(`^(${de.join("|")})`),be=RegExp(`\\.(${he.join("|")})$`,"i");var Pe=function(e,t){if(t.relative.match(be)){const t=new le(e);return ge(t.topNode,e=>{if(!e.tag||3===e.type)return;const a=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&a&&!a.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",a+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const r=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&r&&t.setAttr(e,"src",r.replace(be,"."+ue.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(me)){const a=t.replace(me,ue.directivePrefix);e.attrsMap[a]=e.attrsMap[t],a!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:ye,mpTypeNamespace:ve}=X,we=Object.keys(ve).map(e=>ve[e].css),je=RegExp(`\\.(${we.join("|")})$`,"i");var ke=function(e,{relative:t}){return t.match(je)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(je,"."+ye.css)}'`}))),e};var xe=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:$e}=$.default;var Se=function(e,{relative:t}){if(t.match(/\.js$/i))try{return $e(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:_e}=X,{preprocess:Oe}=$.default;var Ee=function(e,{relative:t}){if(t.match(RegExp(`.${_e.css}$`,"i")))try{return Oe(e,process.env,{type:"css"})}catch(t){return console.log(_e.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:Me}=X,{preprocess:Ce}=$.default;var Ae=function(e,{relative:t}){if(t.match(RegExp(`.${Me.html}$`,"i")))try{return Ce(e,process.env,{type:"html"})}catch(t){return console.log(Me.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:Re,currentNamespace:Ne}=X;process;const Te=new Set(Object.keys(Re).map(e=>Re[e].globalObject));var Le={mixinsEnvCode:function(e){let t="";return Te.forEach(e=>{Ne.globalObject!==e&&(t+=`var ${e} = ${Ne.globalObject};\n`)}),t}};const{mixinsEnvCode:qe}=Le;var Be=function(e,{relative:t}){return t.match(/\.js$/i)?qe()+e:e};const{projectToSubPackageConfig:{subPackagePath:Fe},basePath:Je,currentNamespace:{webpackGlobal:We}}=X;const Ie={library:`webpackJsonp_${Fe}_${S.default(Fe+(0,E.default)()+Math.random()+Date.now())}`,reference:"webpackJsonp"};var Ue={htmlMixinPlugin:Pe,cssMixinPlugin:ke,polyfillPlugin:xe,jsPreProcessPlugin:Se,cssPreProcessPlugin:Ee,htmlPreProcessPlugin:Ae,jsMixinPlugin:Be,setLibrary:function(e,{fromAbsolute:t},a,n={}){n={...Ie,...n};let r=!1;if(t.startsWith(Je)&&".js"===v.default.extname(t)){const t=_.default.parse(e),a=_.default(t);for(const{name:e,nodes:t}of a)if(e===We)for(const{parents:e}of t)for(const t of e){const{type:e,property:{type:a,value:s}={}}=t;"MemberExpression"===e&&"Literal"===a&&s===n.reference&&(t.property.value=n.library,r=!0)}if(r){const e="production"===process.env.NODE_ENV?O.default.FORMAT_MINIFY:O.default.FORMAT_DEFAULTS;return O.default.generate(t,{format:e})}}return e}};const{projectToSubPackageConfig:De,targetPath:Ke}=X,He=v.default;(!De.plugins||!De.plugins instanceof Array)&&(De.plugins=[]);var Ye={runPlugins:function(e){return function(t){const{plugins:a}=De;if(a&&!(!a instanceof Array))return a.reduce((t,a)=>{if("string"==typeof a&&(a=Ue[a]),"function"!=typeof a)return t;const n=He.resolve(e,this.file.relative),r={relative:n.replace(RegExp("^"+Ke.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:n,fromAbsolute:this.file.path,fromRelative:this.file.relative};this.removeAfterAdd=function(e){!function(e){M.default.existsSync(e)&&M.default.removeSync(e);const t=C.default.watch(e);t.on("add",(function(){M.default.removeSync(e),t.close()}))}(e=e||n)};const s=a.call(this,t,r,Ue);return null==s?t:s},t)}}};const Ge=k.default(),{cwd:Ve,projectToSubPackageConfig:{subPackagePath:ze},target:Ze,env:Qe,pluginProcessFileTypes:Xe,sourceCodePath:et,currentNamespace:{pluginConfig:tt}}=X,{writeLastLine:at}=ae,{runPlugins:nt}=Ye;y.default.task("watch:pluginJson",(function(){const e=Ge.filter(Xe.map(e=>"**/*."+e),{restore:!0}),t=`${et}/${tt}`;return y.default.src(t,{allowEmpty:!0,cwd:Ve}).pipe(Ge.if("dev"===Qe,Ge.watch(t,{cwd:Ve},(function(e){at("处理"+e.relative+"......")})))).pipe(e).pipe(Ge.replace(/[\s\S]*/,nt(v.default.resolve(Ve,Ze+"/"+ze)),{skipBinary:!1})).pipe(e.restore).pipe(y.default.dest(Ze+"/"+ze,{cwd:Ve}))}));const rt=k.default(),{cwd:st,target:it,env:pt,targetPath:ot,pluginProcessFileTypes:ct,currentNamespace:lt,projectConfigPath:ut}=X,{writeLastLine:ft}=ae,{runPlugins:gt}=Ye;y.default.task("watch:projectConfigJson",(function(){const e=rt.filter(ct.map(e=>"**/*."+e),{restore:!0});return y.default.src(`${ut?ut+"/":""}${lt.projectConfig}`,{allowEmpty:!0,cwd:st}).pipe(rt.if("dev"===pt,rt.watch(`${ut?ut+"/":""}${lt.projectConfig}`,{cwd:st},(function(e){ft("处理"+e.relative+"......")})))).pipe(e).pipe(rt.replace(/[\s\S]*/,gt(ot),{skipBinary:!1})).pipe(e.restore).pipe(y.default.dest(it,{cwd:st}))}));const{runPlugins:dt}=Ye,{program:ht,cwd:mt,projectToSubPackageConfig:bt,subModePath:Pt,targetPath:yt,packIsSubpackage:vt,currentNamespace:wt,target:jt,pluginTypeMiniProgramRoot:kt}=X;var xt=function(){if(ht.plugin)return;const e=v.default.resolve(mt,bt[wt.mainMpPath]+"/app.js");if(M.default.existsSync(e)){const t=M.default.readFileSync(e,"utf8");let a=`./${bt.subPackagePath}/`,n="app.js";Pt===yt&&(n="uni-bootstrap.js");let r=`require('${a}${n}');\n`;(vt.mode||ht.plugin)&&(r="");const s=new R.default({cwd:mt,base:v.default.resolve(mt,bt[wt.mainMpPath]),path:e});M.default.outputFileSync(yt+"/"+s.relative,dt(v.default.resolve(mt,jt+(ht.plugin?"/"+kt:""))).call({file:s},r+t))}};const $t=k.default(),{program:St,cwd:_t,projectToSubPackageConfig:Ot,configWxResourceKey:Et,base:Mt,packIsSubpackage:Ct,currentNamespace:At,sourceCodePath:Rt}=X,{writeLastLine:Nt}=ae;var Tt=function(e){return Nt("处理app.json......"),$t.replace(/[\s\S]+/,(function(t){if(St.plugin&&"mainAppJson"===e)return t;Ct.mode=!1;let a,n,r,s={};({pagesJson(){try{a=JSON.parse(A.default(t))}catch(e){a={}}},baseAppJson(){try{n=JSON.parse(t)}catch(e){n={}}},mainAppJson(){try{r=JSON.parse(t)}catch(e){r={}}}})[e]();try{a||(a=JSON.parse(A.default(M.default.readFileSync(v.default.resolve(_t,Rt+"/pages.json"),"utf8"))))}catch(e){a={}}try{n||(n=JSON.parse(M.default.readFileSync(v.default.resolve(_t,Mt+"/app.json"),"utf8")))}catch(e){n={}}try{r||(r=JSON.parse(M.default.readFileSync(v.default.resolve(_t,Ot[At.mainMpPath]+"/app.json"),"utf8")))}catch(e){r={}}function i(e){return Ot.subPackagePath+(Ot.subPackagePath?"/":"")+e}if(r.subpackages&&!r.subPackages&&(r.subPackages=r.subpackages),r.subPackages){let e=r.subPackages.find(e=>e.root===Ot.subPackagePath);if(e){Ct.mode=!0;let t=[...a[Et]&&a[Et].pages||[],...n.pages||[]];return n.subPackages&&n.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[Et]&&a[Et].subPackages&&a[Et].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,xt.call(this),delete n.pages,delete n.subPackages,JSON.stringify({...n,...r},null,2)}}n.pages&&n.pages.forEach((e,t)=>{n.pages[t]=i(e)}),n.subPackages&&n.subPackages.forEach(e=>{e.root=i(e.root)}),a[Et]&&(a[Et].pages&&a[Et].pages.forEach((e,t)=>{a[Et].pages[t]=i(e)}),a[Et].subPackages&&a[Et].subPackages.forEach(e=>{e.root=i(e.root)})),n.tabBar&&n.tabBar.list&&n.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...r},s)=>{n.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:a?i(a):"",...r}}),s={...n,...r},s.pages=Array.from(new Set([...a.indexPage?[i(a.indexPage)]:[],...r.pages||[],...n.pages||[],...a[Et]&&a[Et].pages||[]]));let p=[],o={},c={};function l(e){e.forEach(e=>{o[e.root]=o[e.root]?Array.from(new Set([...o[e.root],...e.pages])):e.pages,e.name&&(c[e.root]=e.name)})}l(a[Et]&&a[Et].subPackages||[]),l(n.subPackages||[]),l(r.subPackages||[]);for(let e in o){const t={root:e,pages:o[e]};c[e]&&(t.name=c[e]),p.push(t)}if(s.subPackages=[...p],n.usingComponents){for(let e in n.usingComponents)n.usingComponents[e]="/"+Ot.subPackagePath+n.usingComponents[e];s.usingComponents={...s.usingComponents||{},...n.usingComponents}}return xt.call(this),"toutiao"===St.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const Lt=k.default(),{cwd:qt,target:Bt,env:Ft,targetPath:Jt,pluginProcessFileTypes:Wt,sourceCodePath:It}=X,{writeLastLine:Ut}=ae,{runPlugins:Dt}=Ye;y.default.task("watch:pagesJson",(function(){const e=Lt.filter(Wt.map(e=>"**/*."+e),{restore:!0});return y.default.src(It+"/pages.json",{allowEmpty:!0,cwd:qt}).pipe(Lt.if("dev"===Ft,Lt.watch(It+"/pages.json",{cwd:qt},(function(e){Ut("处理"+e.relative+"......")})))).pipe(Tt("pagesJson")).pipe(Lt.rename("app.json")).pipe(e).pipe(Lt.replace(/[\s\S]*/,Dt(Jt),{skipBinary:!1})).pipe(e.restore).pipe(y.default.dest(Bt,{cwd:qt}))}));const Kt=k.default(),{cwd:Ht,target:Yt,env:Gt,base:Vt,targetPath:zt,pluginProcessFileTypes:Zt}=X,{writeLastLine:Qt}=ae,{runPlugins:Xt}=Ye;y.default.task("watch:baseAppJson",(function(){const e=Kt.filter(Zt.map(e=>`${Vt}/**/*.${e}`),{restore:!0});return y.default.src(Vt+"/app.json",{allowEmpty:!0,cwd:Ht}).pipe(Kt.if("dev"===Gt,Kt.watch(Vt+"/app.json",{cwd:Ht},(function(e){Qt("处理"+e.relative+"......")})))).pipe(Tt("baseAppJson")).pipe(e).pipe(Kt.replace(/[\s\S]*/,Xt(zt),{skipBinary:!1})).pipe(e.restore).pipe(y.default.dest(Yt,{cwd:Ht}))}));const ea=k.default(),{cwd:ta,target:aa,env:na,projectToSubPackageConfig:ra,program:sa,currentNamespace:ia,pluginProcessFileTypes:pa,pluginTypeMiniProgramRoot:oa}=X,{writeLastLine:ca}=ae,{runPlugins:la}=Ye;y.default.task("watch:mainAppJson",(function(){const e=ra[ia.mainMpPath],t=ea.filter(pa.map(t=>`${e}/**/*.${t}`),{restore:!0});return y.default.src(e+"/app.json",{allowEmpty:!0,cwd:ta}).pipe(ea.if("dev"===na,ea.watch(e+"/app.json",{cwd:ta},(function(e){ca("处理"+e.relative+"......")})))).pipe(Tt("mainAppJson")).pipe(t).pipe(ea.replace(/[\s\S]*/,la(v.default.resolve(ta,aa+(sa.plugin?"/"+oa:""))),{skipBinary:!1})).pipe(t.restore).pipe(y.default.dest(aa+(sa.plugin?"/"+oa:""),{cwd:ta}))}));const ua=k.default(),{cwd:fa,target:ga,env:da,projectToSubPackageConfig:ha,program:ma,basePath:ba,currentNamespace:Pa,mpTypeNamespace:ya,pluginProcessFileTypes:va,pluginTypeMiniProgramRoot:wa}=X,{writeLastLine:ja}=ae,{runPlugins:ka}=Ye;y.default.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=ha[Pa.mainMpPath];const t=Object.keys(ya).map(t=>`${e}/app.${ya[t].css}`),a=ua.filter([...t],{restore:!0}),n=ua.filter([e+"/app.js"],{restore:!0}),r=ua.filter(va.map(t=>`${e}/**/*.${t}`),{restore:!0});return y.default.src([e+"/app.js",...t],{allowEmpty:!0,cwd:fa}).pipe(ua.if("dev"===da,ua.watch([e+"/app.js",`${e}/app.${Pa.css}`],{cwd:fa},(function(e){ja("处理"+e.relative+"......")})))).pipe(n).pipe(ua.replace(/^/,(function(e){return"require('./uni-bootstrap.js');\n"}),{skipBinary:!1})).pipe(n.restore).pipe(a).pipe(ua.replace(/^/,(function(e){return M.default.readFileSync(`${ba}/app.${Pa.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(ua.rename((function(e){e.extname="."+Pa.css}))).pipe(a.restore).pipe(r).pipe(ua.replace(/[\s\S]*/,ka(v.default.resolve(fa,ga+(ma.plugin?"/"+wa:""))),{skipBinary:!1})).pipe(r.restore).pipe(y.default.dest(ga+(ma.plugin?"/"+wa:""),{cwd:fa}))}));const xa=k.default(),{cwd:$a,target:Sa,env:_a,projectToSubPackageConfig:Oa,base:Ea,wxResourcePath:Ma,currentNamespace:Ca,mpTypeNamespace:Aa,pluginProcessFileTypes:Ra}=X,{writeLastLine:Na}=ae,{runPlugins:Ta}=Ye;y.default.task("watch:mainWeixinMpPackPath",(function(){const e=Oa[Ca.mainMpPath],t=e+"/"+Oa.subPackagePath,a=Sa+"/"+Oa.subPackagePath,n=[],r=[],s=new Set,i=new Set;Object.keys(Aa).forEach(e=>{n.push(`${t}/**/*.${Aa[e].css}`),r.push(`${t}/**/*.${Aa[e].html}`),s.add("."+Aa[e].css),i.add("."+Aa[e].html)});const p=xa.filter([...r],{restore:!0}),o=xa.filter([...n],{restore:!0});xa.filter([t+"/**/*.js"],{restore:!0});const c=xa.filter(Ra.map(e=>`${t}/**/*.${e}`),{restore:!0});return y.default.src([t,t+"/**/*","!"+t+"/pack.config.js"],{allowEmpty:!0,cwd:$a}).pipe(xa.if("dev"===_a,xa.watch([t,t+"/**/*","!/"+t+"/pack.config.js"],{cwd:$a},(function(e){Na("处理"+e.relative+"......")})))).pipe(xa.filter((function(t){if(t.relative!==Ca.projectConfig&&!function(e){const t=Oa[Ca.mainMpPath]+"/"+Oa.subPackagePath;return M.default.existsSync(e.path.replace(v.default.resolve($a,t),v.default.resolve($a,Ea)))?["ext.json",Ca.projectConfig].indexOf(e.relative)>-1&&Oa.mergePack&&""===Oa.subPackagePath:!M.default.existsSync(e.path.replace(v.default.resolve($a,t),v.default.resolve($a,Ma)))}(t))return!1;if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");s.has(t.extname)&&(a=a.replace(n,"."+Ca.css)),i.has(t.extname)&&(a=a.replace(n,"."+Ca.html)),P.default.sync([a.replace(v.default.resolve($a,e),v.default.resolve($a,Sa))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(xa.rename((function(e){e.extname="."+Ca.html}))).pipe(p.restore).pipe(o).pipe(xa.rename((function(e){e.extname="."+Ca.css}))).pipe(o.restore).pipe(c).pipe(xa.replace(/[\s\S]*/,Ta(v.default.resolve($a,a)),{skipBinary:!1})).pipe(c.restore).pipe(y.default.dest(a,{cwd:$a}))}));const La=k.default(),{cwd:qa,target:Ba,env:Fa,projectToSubPackageConfig:Ja,subModePath:Wa,targetPath:Ia,program:Ua,packIsSubpackage:Da,currentNamespace:Ka,mpTypeNamespace:Ha,pluginProcessFileTypes:Ya,pluginTypeMiniProgramRoot:Ga}=X,{writeLastLine:Va}=ae,{runPlugins:za}=Ye;y.default.task("watch:mainWeixinMp",(function(){const e=Ja[Ka.mainMpPath],t=e+"/"+Ja.subPackagePath,a=[],n=[],r=new Set,s=new Set;Object.keys(Ha).forEach(t=>{a.push(`${e}/**/*.${Ha[t].css}`),n.push(`${e}/**/*.${Ha[t].html}`),r.add("."+Ha[t].css),s.add("."+Ha[t].html)});const i=La.filter([e+"/app.js"],{restore:!0});La.filter([e+"/**/*.js"],{restore:!0});const p=La.filter([...n],{restore:!0}),o=La.filter([...a],{restore:!0}),c=La.filter(Ya.map(t=>`${e}/**/*.${t}`),{restore:!0});return y.default.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Ka.html}___jb_tmp___`,"!"+e+`/**/*.${Ka.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+t+"/**/*"],{base:v.default.resolve(qa,e),allowEmpty:!0,cwd:qa}).pipe(La.if("dev"===Fa,La.watch([e+"/**/*","!/"+e+"/app.json","!/"+t+"/**/*"],{cwd:qa},(function(e){e.relative.match(/.json/),Va("处理"+e.relative+"......")})))).pipe(La.filter((function(t){if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");r.has(t.extname)&&(a=a.replace(n,"."+Ka.css)),s.has(t.extname)&&(a=a.replace(n,"."+Ka.html)),P.default.sync([a.replace(v.default.resolve(qa,e),v.default.resolve(qa,Ba))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(La.replace(/[\s\S]*/,(function(e){if(Da.mode||Ua.plugin)return e;let t=`./${Ja.subPackagePath}/`,a="app.js";return Wa===Ia&&(a="uni-bootstrap.js"),e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}${a}');\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(p).pipe(La.rename((function(e){e.extname="."+Ka.html}))).pipe(p.restore).pipe(o).pipe(La.rename((function(e){e.extname="."+Ka.css}))).pipe(o.restore).pipe(c).pipe(La.replace(/[\s\S]*/,za(v.default.resolve(qa,Ba+(Ua.plugin?"/"+Ga:""))),{skipBinary:!1})).pipe(c.restore).pipe(y.default.dest(Ba+(Ua.plugin?"/"+Ga:""),{cwd:qa}))}));var Za={fakeUniBootstrap:function(e,t,a,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),globalObject.onAppHide&&globalObject.onAppShow||(a="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==a||globalObject.onAppRoute||(a="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var r=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?r.__packInit[s]=e[s]:function(t){r.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==a){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==a&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(n){if("top"===a)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,n);var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===a&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===a&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(n){if("top"!==a){var r=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var a=getCurrentPages(),n=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const{basePath:Qa,targetPath:Xa,subModePath:en,currentNamespace:tn}=X;var an=function(e){const t=v.default.resolve(Xa,"app.js"),a=v.default.resolve(Xa,"app."+tn.css),n=e.path.replace(Qa,en);return t===n||a===n};const nn=k.default(),{regExpWxResources:rn,regExpUniRequire:sn}=X,{getLevelPath:pn,getLevel:on}=ae;var cn={uniRequireWxResource:function(){return nn.replace(/[\s\S]*/,(function(e,t){const a=["var __uniPackNativeRequireInject={};\n"],n=on(this.file.relative);return e=e.replace(sn,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(rn,pn(n))})`);const r=t.replace(rn,pn(n)),s=`__uniPackNativeRequireInject[${r}] = require(${r});\n`;return 0>a.indexOf(s)&&a.push(s),`__uniPackNativeRequireInject[${r}]`}),a[1]?`${a.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:ln,regExpWxResources:un,wxResourceAlias:fn}=X,{getLevelPath:gn,getLevel:dn}=ae;var hn=function(e,t){const a=dn(t);return"@import "+`"${fn}/app.${ln.css}";`.replace(un,gn(a))+("\n"+e)};const mn=k.default(),{fakeUniBootstrapName:bn,fakeUniBootstrap:Pn}=Za,{cwd:yn,env:vn,program:wn,basePath:jn,targetPath:kn,subModePath:xn,base:$n,regExpUniRequire:Sn,regExpWxResources:_n,regExpUniImportWxss:On,currentNamespace:En,mpTypeNamespace:Mn,pluginProcessFileTypes:Cn,sourceCodePath:An,projectToSubPackageConfig:Rn}=X,Nn=process.env.PACK_TYPE,{writeLastLine:Tn,getLevel:Ln,getLevelPath:qn,deepFind:Bn}=ae,{uniRequireWxResource:Fn}=cn,{runPlugins:Jn}=Ye,Wn=Object.keys(Mn).map(e=>Mn[e].css),In=new Set(Wn);y.default.task("subMode:createUniSubPackage",(function(){M.default.mkdirsSync(jn);const e=mn.filter($n+"/**/*.js",{restore:!0}),t=mn.filter([$n+"/common/vendor.js"],{restore:!0}),a=mn.filter([$n+"/common/main.js"],{restore:!0}),n=mn.filter(Cn.map(e=>`${$n}/**/*.${e}`),{restore:!0}),r=mn.filter([$n+"/**/*.js","!"+$n+"/app.js","!"+$n+"/uni-bootstrap.js","!"+$n+"/common/vendor.js","!"+$n+"/common/main.js","!"+$n+"/common/runtime.js"],{restore:!0}),s=mn.filter([`${$n}/**/*.${En.css}`,`!${$n}/app.${En.css}`,`!${$n}/common/main.${En.css}`],{restore:!0}),i=mn.filter([`${$n}/**/*.${En.css}`,`!${$n}/app.${En.css}`],{restore:!0}),p=mn.filter([$n+"/**/*.json"],{restore:!0}),o=mn.filter([`${$n}/**/*.${En.html}`],{restore:!0});return y.default.src([$n+"/**","!"+$n+"/app.json",$n+"/app.js",`${$n}/app.${En.css}`],{allowEmpty:!0,cwd:yn}).pipe(mn.if("dev"===vn,mn.watch([$n+"/**/*","!/"+$n+"/app.json"],{cwd:yn},(function(e){Tn("处理"+e.relative+"......")})))).pipe(mn.filter((function(e){if(function(e){if(0>["ext.json",En.projectConfig].indexOf(e.relative))return!1;if(Rn.mergePack&&""===Rn.subPackagePath){if(M.default.existsSync(v.default.resolve(yn,Rn[En.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");In.has(e.extname.substr(1))&&(t=t.replace(a,"."+En.css)),P.default.sync([t.replace(jn,v.default.resolve(yn,xn))],{force:!0})}catch(e){}return!1}return!an(e)||".js"===e.extname&&(e.basename="uni-bootstrap.js",!0)}))).pipe(o).pipe(mn.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(En.html+"$","i"),En.css),a=this.file.relative.replace(RegExp(En.html+"$","i"),En.css);M.default.existsSync(t)||M.default.outputFileSync(v.default.resolve(yn,xn,a),hn("",a));const n=new le(e);let r=0;return Bn(n.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(Sn,(t,a,n,s)=>{const i=Ln(this.file.relative),p=a.replace(_n,qn(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],r=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),r?n.render():e}),{skipBinary:!1})).pipe(o.restore).pipe(t).pipe(mn.replace(/^/,(function(e){return wn.plugin?`var App=function(packInit){};${En.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${bn}=${(""+Pn).replace(/globalObject/g,En.globalObject)};${bn}(packInit,__packConfig.packPath,__packConfig.appMode,'${Nn}');};`}),{skipBinary:!1})).pipe(t.restore).pipe(e).pipe(N.default()).pipe(Fn()).pipe(e.restore).pipe(a).pipe(mn.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(mn.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(a.restore).pipe(r).pipe(mn.replace(/^/,(function(e){if(M.default.existsSync(v.default.resolve(yn,An,this.file.relative)))return e;let t=qn(Ln(this.file.relative)),a="app.js";return xn===kn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(r.restore).pipe(p).pipe(mn.replace(/[\s\S]*/,(function(e){if(!M.default.existsSync(v.default.resolve(yn,An,this.file.relative.replace(/json$/,"vue")))&&!M.default.existsSync(v.default.resolve(yn,An,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=qn(Ln(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(p.restore).pipe(i).pipe(mn.stripCssComments()).pipe(mn.replace(On,(function(e,t,a){let n="",r=Ln(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const a=RegExp(`(${Wn.join("|")})(['"])$`);t=t.replace(a,En.css+"$2"),n+=`@import ${t.replace(_n,qn(r))};\n`})),t+n}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(mn.stripCssComments()).pipe(mn.replace(/^[\s\S]*$/,(function(e){return xn===kn?e:hn(e,this.file.relative)}),{skipBinary:!1})).pipe(s.restore).pipe(n).pipe(mn.replace(/[\s\S]*/,Jn(xn),{skipBinary:!1})).pipe(n.restore).pipe(y.default.dest(xn,{cwd:yn}))}));const Un=k.default(),{cwd:Dn,env:Kn,targetPath:Hn,subModePath:Yn,regExpWxResources:Gn,regExpUniImportWxss:Vn,wxResourcePath:zn,currentNamespace:Zn,mpTypeNamespace:Qn,pluginProcessFileTypes:Xn,projectToSubPackageConfig:er}=X,{writeLastLine:tr,getLevel:ar,getLevelPath:nr}=ae,{uniRequireWxResource:rr}=cn,{runPlugins:sr}=Ye,ir=[],pr=[],or=[],cr=new Set,lr=new Set;Object.keys(Qn).forEach(e=>{ir.push(Qn[e].css),pr.push(`${zn}/**/*.${Qn[e].css}`),or.push(`${zn}/**/*.${Qn[e].html}`),cr.add("."+Qn[e].css),lr.add("."+Qn[e].html)}),y.default.task("subMode:copyWxResource",(function(){const e=er[Zn.mainMpPath],t=Un.filter([zn+"/**/*.js"],{restore:!0}),a=Un.filter([...pr],{restore:!0}),n=Un.filter([...or],{restore:!0}),r=Un.filter(Xn.map(e=>`${zn}/**/*${e}`),{restore:!0});return y.default.src([zn+"/**",zn,`!${e}/app.json`],{allowEmpty:!0,cwd:Dn}).pipe(Un.if("dev"===Kn,Un.watch([zn+"/**",zn,`!/${e}/app.json`,`!/${zn}/**/*.*___jb_tmp___`],{cwd:Dn},(function(e){tr("处理"+e.relative+"......")})))).pipe(t).pipe(Un.replace(/^/,(function(e){let t=nr(ar(this.file.relative)),a="app.js";return Yn===Hn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(N.default()).pipe(rr()).pipe(t.restore).pipe(a).pipe(Un.stripCssComments()).pipe(Un.replace(Vn,(function(e,t,a){let n="";ar(this.file.relative);return t+n}),{skipBinary:!1})).pipe(Un.replace(/^[\s\S]*$/,(function(e){return Yn===Hn?e:hn(e,this.file.relative)}),{skipBinary:!1})).pipe(Un.rename((function(e){e.extname="."+Zn.css}))).pipe(a.restore).pipe(n).pipe(Un.rename((function(e){e.extname="."+Zn.html}))).pipe(n.restore).pipe(Un.filter((function(e){if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");cr.has(e.extname)&&(t=t.replace(a,"."+Zn.css)),lr.has(e.extname)&&(t=t.replace(a,"."+Zn.html)),P.default.sync([t.replace(v.default.resolve(Dn,zn),v.default.resolve(Dn,Yn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(r).pipe(Un.replace(/[\s\S]*/,sr(Yn),{skipBinary:!1})).pipe(r.restore).pipe(y.default.dest(Yn,{cwd:Dn}))}));const ur=k.default(),{cwd:fr,target:gr,env:dr,projectToSubPackageConfig:hr,currentNamespace:mr,mpTypeNamespace:br,pluginProcessFileTypes:Pr}=X,{writeLastLine:yr}=ae,{runPlugins:vr}=Ye;y.default.task("watch:native",(function(){const e=hr[mr.mainMpPath],t=[],a=[],n=new Set,r=new Set;Object.keys(br).forEach(s=>{t.push(`${e}/**/*.${br[s].css}`),a.push(`${e}/**/*.${br[s].html}`),n.add("."+br[s].css),r.add("."+br[s].html)}),ur.filter([e+"/**/*.js"],{restore:!0});const s=ur.filter([...a],{restore:!0}),i=ur.filter([...t],{restore:!0}),p=ur.filter(Pr.map(t=>`${e}/**/*.${t}`),{restore:!0});return y.default.src([e+"/**/*","!"+e+"/app.json"],{base:v.default.resolve(fr,e),allowEmpty:!0,cwd:fr}).pipe(ur.if("dev"===dr,ur.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:fr},(function(e){yr("处理"+e.relative+"......")})))).pipe(ur.filter((function(t){if("unlink"===t.event){try{let a=t.path;const s=RegExp(t.extname+"$","i");n.has(t.extname)&&(a=a.replace(s,"."+mr.css)),r.has(t.extname)&&(a=a.replace(s,"."+mr.html)),P.default.sync([a.replace(v.default.resolve(fr,e),v.default.resolve(fr,gr))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(s).pipe(ur.rename((function(e){e.extname="."+mr.html}))).pipe(s.restore).pipe(i).pipe(ur.rename((function(e){e.extname="."+mr.css}))).pipe(i.restore).pipe(p).pipe(ur.replace(/[\s\S]*/,vr(v.default.resolve(fr,gr)),{skipBinary:!1})).pipe(p.restore).pipe(y.default.dest(gr,{cwd:fr}))}));const{cwd:wr,env:jr,targetPath:kr,subModePath:xr,projectToSubPackageConfig:$r,program:Sr,currentNamespace:_r}=X,{tryAgain:Or}=ae;async function Er(e){let t=v.default.resolve(wr,$r[_r.mainMpPath],"app.js");await M.default.exists(t)||await M.default.outputFile(t,"App({});"),e()}y.default.task("mpWxSubMode",y.default.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(Sr.plugin||Sr.native)t();else{try{let e={packPath:($r.subPackagePath?"/":"")+$r.subPackagePath,appMode:$r.appMode};await M.default.outputFile(xr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await Or(async()=>{await e(t)})}t()}}),function(){let e=[Er,"subMode:createUniSubPackage","subMode:copyWxResource",...Sr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...$r.mergePack?["watch:mainWeixinMpPackPath"]:[],...xr===kr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return Sr.native&&(e=[Er,"watch:mainAppJson","watch:native"]),"build"===jr?y.default.series.apply(this,e):y.default.parallel.apply(this,e)}(),(function(e){e(),"build"===jr&&process.exit()})));const{cwd:Mr,basePath:Cr,base:Ar,program:Rr}=X;y.default.task("startToPackServe",y.default.series((async function(e){Rr.native||await M.default.exists(Cr)||await M.default.mkdirs(Cr),e()}),"clean:base",(function(e){Rr.native?e():y.default.watch(Ar+"/app.json",{events:["all"],cwd:Mr},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});exports.default={};
