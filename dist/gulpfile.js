"use strict";var e=require("del"),t=require("gulp"),a=require("path"),n=require("commander"),r=require("single-line-log"),s=require("gulp-load-plugins"),i=require("vue-template-compiler"),p=require("preprocess"),o=require("fs-extra"),c=require("chokidar"),l=require("strip-json-comments"),u=require("vinyl"),f=require("gulp-strip-comments");function g(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=g(e),h=g(t),m=g(a),P=g(n),b=g(r),v=g(s),y=g(i),w=g(p),j=g(o),k=g(c),x=g(l),$=g(u),S=g(f);const{program:O}=P.default;O.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),O.parse(process.argv);const _={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json"}},E=_[O.type];if(!E)throw Error("小程序类型错");process.env.PACK_TYPE=O.type;const C=O.scope,A=function(){return require.apply(null,arguments)}(m.default.resolve(C,"./projectToSubPackageConfig")),N=A.sourceCodePath||"src",M=A.wxResourcePath||`${N}/${E.globalObject}resource`,R=A.wxResourceAlias||"@wxResource",T=RegExp(R+"\\/","g"),L=A.uniRequireApiName||"__uniRequireWx",B=RegExp(L+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),q=A.uniImportWxssApiName||"__uniWxss",J=RegExp(`(}|^|\\s|;)${q}\\s*{([^{}]+)}`,"g"),F=A.projectConfigPath||"";let W="dev";"production"===process.env.NODE_ENV&&(W="build");const I="dist/"+W+"/mp-"+O.type;let U="dist/"+W+`/mp-${O.type}-pack`;O.plugin&&(U="dist/"+W+`/mp-${O.type}-pack-plugin`);var K={pluginProcessFileTypes:A.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:E,program:O,cwd:C,projectToSubPackageConfig:A,wxResourcePath:M,wxResourceAlias:R,regExpWxResources:T,uniRequireApiName:L,regExpUniRequire:B,uniImportWxssApiName:q,regExpUniImportWxss:J,configWxResourceKey:A.configWxResourceKey||"wxResource",env:W,base:I,target:U,basePath:m.default.resolve(C,I),subModePath:m.default.resolve(C,U,A.subPackagePath),targetPath:m.default.resolve(C,U),packIsSubpackage:{mode:!1},mpTypeNamespace:_,sourceCodePath:N,projectConfigPath:F};let D;const H=b.default.stdout;var Y={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){H(e),clearTimeout(D),D=setTimeout(()=>{H("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,a,n,r){a&&(a(t,n,r),t.childNodes?t.childNodes.forEach((t,n,r)=>{e(t,a,n,r)}):t.children&&t.children.forEach((t,n,r)=>{e(t,a,n,r)}))}};const{basePath:z}=K,{tryAgain:V}=Y;h.default.task("clean:base",(async function e(t){try{await d.default([z+"/**/*"],{force:!0})}catch(a){return void await V(async()=>{await e(t)})}t()}));const{subModePath:Z}=K,{tryAgain:G}=Y;h.default.task("clean:subModePath",(async function e(t){try{await d.default([Z+"/**/*"],{force:!0})}catch(a){return void await G(async()=>{await e(t)})}t()}));const{targetPath:Q}=K,{tryAgain:X}=Y;h.default.task("clean:previewDist",(async function e(t){try{await d.default([Q+"/**/*"],{force:!0})}catch(a){return void await X(async()=>{await e(t)})}t()}));const{compile:ee}=y.default;var te=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=ee(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,a){if(!e.attrsMap)return"";e.attrsMap[t]=a}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:a,attrsMap:n,children:r=[]}=t;return e+=this.writeOpenTag(a,n),e+=this.render(r),e+=this.writeCloseTag(a)},t)}writeOpenTag(e,t){if(t){const a=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${a.length>0?" "+a.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:ae,mpTypeNamespace:ne}=K,{deepFind:re}=Y,se=Object.keys(ne).map(e=>ne[e].directivePrefix),ie=Object.keys(ne).map(e=>ne[e].html),pe=RegExp(`^(${se.join("|")})`),oe=RegExp(`\\.(${ie.join("|")})$`,"i");var ce=function(e,t){if(t.relative.match(oe)){const t=new te(e);return re(t.topNode,e=>{if(!e.tag||3===e.type)return;const a=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&a&&!a.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",a+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const r=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&r&&t.setAttr(e,"src",r.replace(oe,"."+ae.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(pe)){const a=t.replace(pe,ae.directivePrefix);e.attrsMap[a]=e.attrsMap[t],a!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:le,mpTypeNamespace:ue}=K,fe=Object.keys(ue).map(e=>ue[e].css),ge=RegExp(`\\.(${fe.join("|")})$`,"i");var de=function(e,{relative:t}){return t.match(ge)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(ge,"."+le.css)}'`}))),e};var he=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:me}=w.default;var Pe=function(e,{relative:t}){if(t.match(/\.js$/i))try{return me(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:be}=K,{preprocess:ve}=w.default;var ye=function(e,{relative:t}){if(t.match(RegExp(`.${be.css}$`,"i")))try{return ve(e,process.env,{type:"css"})}catch(t){return console.log(be.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:we}=K,{preprocess:je}=w.default;var ke=function(e,{relative:t}){if(t.match(RegExp(`.${we.html}$`,"i")))try{return je(e,process.env,{type:"html"})}catch(t){return console.log(we.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:xe,currentNamespace:$e}=K,Se=(process,new Set(Object.keys(xe).map(e=>xe[e].globalObject)));var Oe={mixinsEnvCode:function(e){let t="";return Se.forEach(e=>{$e.globalObject!==e&&(t+=`var ${e} = ${$e.globalObject};\n`)}),t}};const{mixinsEnvCode:_e}=Oe;var Ee={htmlMixinPlugin:ce,cssMixinPlugin:de,polyfillPlugin:he,jsPreProcessPlugin:Pe,cssPreProcessPlugin:ye,htmlPreProcessPlugin:ke,jsMixinPlugin:function(e,{relative:t}){return t.match(/\.js$/i)?_e()+e:e}};const{projectToSubPackageConfig:Ce,targetPath:Ae}=K,Ne=m.default;(!Ce.plugins||!Ce.plugins instanceof Array)&&(Ce.plugins=[]);var Me={runPlugins:function(e){return function(t){const{plugins:a}=Ce;if(a&&!(!a instanceof Array))return a.reduce((t,a)=>{if("string"==typeof a&&(a=Ee[a]),"function"!=typeof a)return t;const n=Ne.resolve(e,this.file.relative),r={relative:n.replace(RegExp("^"+Ae.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:n};this.removeAfterAdd=function(e){!function(e){j.default.existsSync(e)&&j.default.removeSync(e);const t=k.default.watch(e);t.on("add",(function(){j.default.removeSync(e),t.close()}))}(e=e||n)};const s=a.call(this,t,r,Ee);return null==s?t:s},t)}}};const Re=v.default(),{cwd:Te,projectToSubPackageConfig:Le,target:Be,env:qe,pluginProcessFileTypes:Je,sourceCodePath:Fe}=K,{writeLastLine:We}=Y,{runPlugins:Ie}=Me;h.default.task("watch:pluginJson",(function(){const e=Re.filter(Je.map(e=>"**/*."+e),{restore:!0});return h.default.src(Fe+"/plugin.json",{allowEmpty:!0,cwd:Te}).pipe(Re.if("dev"===qe,Re.watch(Fe+"/plugin.json",{cwd:Te},(function(e){We("处理"+e.relative+"......")})))).pipe(e).pipe(Re.replace(/[\s\S]*/,Ie(m.default.resolve(Te,Be+"/"+Le.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(h.default.dest(Be+"/"+Le.subPackagePath,{cwd:Te}))}));const Ue=v.default(),{cwd:Ke,target:De,env:He,targetPath:Ye,pluginProcessFileTypes:ze,currentNamespace:Ve,projectConfigPath:Ze}=K,{writeLastLine:Ge}=Y,{runPlugins:Qe}=Me;h.default.task("watch:projectConfigJson",(function(){const e=Ue.filter(ze.map(e=>"**/*."+e),{restore:!0});return h.default.src(`${Ze?Ze+"/":""}${Ve.projectConfig}`,{allowEmpty:!0,cwd:Ke}).pipe(Ue.if("dev"===He,Ue.watch(`${Ze?Ze+"/":""}${Ve.projectConfig}`,{cwd:Ke},(function(e){Ge("处理"+e.relative+"......")})))).pipe(e).pipe(Ue.replace(/[\s\S]*/,Qe(Ye),{skipBinary:!1})).pipe(e.restore).pipe(h.default.dest(De,{cwd:Ke}))}));const{runPlugins:Xe}=Me,{program:et,cwd:tt,projectToSubPackageConfig:at,subModePath:nt,targetPath:rt,packIsSubpackage:st,currentNamespace:it,target:pt}=K;var ot=function(){if(et.plugin)return;const e=m.default.resolve(tt,at[it.mainMpPath]+"/app.js");if(j.default.existsSync(e)){const t=j.default.readFileSync(e,"utf8");let a=`./${at.subPackagePath}/`,n="app.js";nt===rt&&(n="uni-bootstrap.js");let r=`require('${a}${n}');\n`;(st.mode||et.plugin)&&(r="");const s=new $.default({cwd:tt,base:m.default.resolve(tt,at[it.mainMpPath]),path:e});j.default.outputFileSync(rt+"/"+s.relative,Xe(m.default.resolve(tt,pt+(et.plugin?"/miniprogram":""))).call({file:s},r+t))}};const ct=v.default(),{program:lt,cwd:ut,projectToSubPackageConfig:ft,configWxResourceKey:gt,base:dt,packIsSubpackage:ht,currentNamespace:mt,sourceCodePath:Pt}=K,{writeLastLine:bt}=Y;var vt=function(e){return bt("处理app.json......"),ct.replace(/[\s\S]+/,(function(t){if(lt.plugin&&"mainAppJson"===e)return t;ht.mode=!1;let a,n,r,s={};({pagesJson(){try{a=JSON.parse(x.default(t))}catch(e){a={}}},baseAppJson(){try{n=JSON.parse(t)}catch(e){n={}}},mainAppJson(){try{r=JSON.parse(t)}catch(e){r={}}}})[e]();try{a||(a=JSON.parse(x.default(j.default.readFileSync(m.default.resolve(ut,Pt+"/pages.json"),"utf8"))))}catch(e){a={}}try{n||(n=JSON.parse(j.default.readFileSync(m.default.resolve(ut,dt+"/app.json"),"utf8")))}catch(e){n={}}try{r||(r=JSON.parse(j.default.readFileSync(m.default.resolve(ut,ft[mt.mainMpPath]+"/app.json"),"utf8")))}catch(e){r={}}function i(e){return ft.subPackagePath+(ft.subPackagePath?"/":"")+e}if(r.subpackages&&!r.subPackages&&(r.subPackages=r.subpackages),r.subPackages){let e=r.subPackages.find(e=>e.root===ft.subPackagePath);if(e){ht.mode=!0;let t=[...a[gt]&&a[gt].pages||[],...n.pages||[]];return n.subPackages&&n.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[gt]&&a[gt].subPackages&&a[gt].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,ot.call(this),delete n.pages,delete n.subPackages,JSON.stringify({...n,...r},null,2)}}n.pages&&n.pages.forEach((e,t)=>{n.pages[t]=i(e)}),n.subPackages&&n.subPackages.forEach(e=>{e.root=i(e.root)}),a[gt]&&(a[gt].pages&&a[gt].pages.forEach((e,t)=>{a[gt].pages[t]=i(e)}),a[gt].subPackages&&a[gt].subPackages.forEach(e=>{e.root=i(e.root)})),n.tabBar&&n.tabBar.list&&n.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...r},s)=>{n.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:a?i(a):"",...r}}),s={...n,...r},s.pages=Array.from(new Set([...a.indexPage?[i(a.indexPage)]:[],...r.pages||[],...n.pages||[],...a[gt]&&a[gt].pages||[]]));let p=[],o={},c={};function l(e){e.forEach(e=>{o[e.root]=o[e.root]?Array.from(new Set([...o[e.root],...e.pages])):e.pages,e.name&&(c[e.root]=e.name)})}l(a[gt]&&a[gt].subPackages||[]),l(n.subPackages||[]),l(r.subPackages||[]);for(let e in o){const t={root:e,pages:o[e]};c[e]&&(t.name=c[e]),p.push(t)}if(s.subPackages=[...p],n.usingComponents){for(let e in n.usingComponents)n.usingComponents[e]="/"+ft.subPackagePath+n.usingComponents[e];s.usingComponents={...s.usingComponents||{},...n.usingComponents}}return ot.call(this),"toutiao"===lt.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const yt=v.default(),{cwd:wt,target:jt,env:kt,targetPath:xt,pluginProcessFileTypes:$t,sourceCodePath:St}=K,{writeLastLine:Ot}=Y,{runPlugins:_t}=Me;h.default.task("watch:pagesJson",(function(){const e=yt.filter($t.map(e=>"**/*."+e),{restore:!0});return h.default.src(St+"/pages.json",{allowEmpty:!0,cwd:wt}).pipe(yt.if("dev"===kt,yt.watch(St+"/pages.json",{cwd:wt},(function(e){Ot("处理"+e.relative+"......")})))).pipe(vt("pagesJson")).pipe(yt.rename("app.json")).pipe(e).pipe(yt.replace(/[\s\S]*/,_t(xt),{skipBinary:!1})).pipe(e.restore).pipe(h.default.dest(jt,{cwd:wt}))}));const Et=v.default(),{cwd:Ct,target:At,env:Nt,base:Mt,targetPath:Rt,pluginProcessFileTypes:Tt}=K,{writeLastLine:Lt}=Y,{runPlugins:Bt}=Me;h.default.task("watch:baseAppJson",(function(){const e=Et.filter(Tt.map(e=>`${Mt}/**/*.${e}`),{restore:!0});return h.default.src(Mt+"/app.json",{allowEmpty:!0,cwd:Ct}).pipe(Et.if("dev"===Nt,Et.watch(Mt+"/app.json",{cwd:Ct},(function(e){Lt("处理"+e.relative+"......")})))).pipe(vt("baseAppJson")).pipe(e).pipe(Et.replace(/[\s\S]*/,Bt(Rt),{skipBinary:!1})).pipe(e.restore).pipe(h.default.dest(At,{cwd:Ct}))}));const qt=v.default(),{cwd:Jt,target:Ft,env:Wt,projectToSubPackageConfig:It,program:Ut,currentNamespace:Kt,pluginProcessFileTypes:Dt}=K,{writeLastLine:Ht}=Y,{runPlugins:Yt}=Me;h.default.task("watch:mainAppJson",(function(){const e=It[Kt.mainMpPath],t=qt.filter(Dt.map(t=>`${e}/**/*.${t}`),{restore:!0});return h.default.src(e+"/app.json",{allowEmpty:!0,cwd:Jt}).pipe(qt.if("dev"===Wt,qt.watch(e+"/app.json",{cwd:Jt},(function(e){Ht("处理"+e.relative+"......")})))).pipe(vt("mainAppJson")).pipe(t).pipe(qt.replace(/[\s\S]*/,Yt(m.default.resolve(Jt,Ft+(Ut.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(h.default.dest(Ft+(Ut.plugin?"/miniprogram":""),{cwd:Jt}))}));const zt=v.default(),{cwd:Vt,target:Zt,env:Gt,projectToSubPackageConfig:Qt,program:Xt,basePath:ea,currentNamespace:ta,mpTypeNamespace:aa,pluginProcessFileTypes:na}=K,{writeLastLine:ra}=Y,{runPlugins:sa}=Me;h.default.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=Qt[ta.mainMpPath];const t=Object.keys(aa).map(t=>`${e}/app.${aa[t].css}`),a=zt.filter([...t],{restore:!0}),n=zt.filter([e+"/app.js"],{restore:!0}),r=zt.filter(na.map(t=>`${e}/**/*.${t}`),{restore:!0});return h.default.src([e+"/app.js",...t],{allowEmpty:!0,cwd:Vt}).pipe(zt.if("dev"===Gt,zt.watch([e+"/app.js",`${e}/app.${ta.css}`],{cwd:Vt},(function(e){ra("处理"+e.relative+"......")})))).pipe(n).pipe(zt.replace(/^/,(function(e){return"require('./uni-bootstrap.js');\n"}),{skipBinary:!1})).pipe(n.restore).pipe(a).pipe(zt.replace(/^/,(function(e){return j.default.readFileSync(`${ea}/app.${ta.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(zt.rename((function(e){e.extname="."+ta.css}))).pipe(a.restore).pipe(r).pipe(zt.replace(/[\s\S]*/,sa(m.default.resolve(Vt,Zt+(Xt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(r.restore).pipe(h.default.dest(Zt+(Xt.plugin?"/miniprogram":""),{cwd:Vt}))}));const ia=v.default(),{cwd:pa,target:oa,env:ca,projectToSubPackageConfig:la,base:ua,wxResourcePath:fa,currentNamespace:ga,mpTypeNamespace:da,pluginProcessFileTypes:ha}=K,{writeLastLine:ma}=Y,{runPlugins:Pa}=Me;h.default.task("watch:mainWeixinMpPackPath",(function(){const e=la[ga.mainMpPath],t=e+"/"+la.subPackagePath,a=oa+"/"+la.subPackagePath,n=[],r=[],s=new Set,i=new Set;Object.keys(da).forEach(e=>{n.push(`${t}/**/*.${da[e].css}`),r.push(`${t}/**/*.${da[e].html}`),s.add("."+da[e].css),i.add("."+da[e].html)});const p=ia.filter([...r],{restore:!0}),o=ia.filter([...n],{restore:!0}),c=(ia.filter([t+"/**/*.js"],{restore:!0}),ia.filter(ha.map(e=>`${t}/**/*.${e}`),{restore:!0}));return h.default.src([t,t+"/**/*","!"+t+"/pack.config.js"],{allowEmpty:!0,cwd:pa}).pipe(ia.if("dev"===ca,ia.watch([t,t+"/**/*","!/"+t+"/pack.config.js"],{cwd:pa},(function(e){ma("处理"+e.relative+"......")})))).pipe(ia.filter((function(t){if(t.relative!==ga.projectConfig&&!function(e){const t=la[ga.mainMpPath]+"/"+la.subPackagePath;return j.default.existsSync(e.path.replace(m.default.resolve(pa,t),m.default.resolve(pa,ua)))?["ext.json",ga.projectConfig].indexOf(e.relative)>-1&&la.mergePack&&""===la.subPackagePath:!j.default.existsSync(e.path.replace(m.default.resolve(pa,t),m.default.resolve(pa,fa)))}(t))return!1;if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");s.has(t.extname)&&(a=a.replace(n,"."+ga.css)),i.has(t.extname)&&(a=a.replace(n,"."+ga.html)),d.default.sync([a.replace(m.default.resolve(pa,e),m.default.resolve(pa,oa))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(ia.rename((function(e){e.extname="."+ga.html}))).pipe(p.restore).pipe(o).pipe(ia.rename((function(e){e.extname="."+ga.css}))).pipe(o.restore).pipe(c).pipe(ia.replace(/[\s\S]*/,Pa(m.default.resolve(pa,a)),{skipBinary:!1})).pipe(c.restore).pipe(h.default.dest(a,{cwd:pa}))}));const ba=v.default(),{cwd:va,target:ya,env:wa,projectToSubPackageConfig:ja,subModePath:ka,targetPath:xa,program:$a,packIsSubpackage:Sa,currentNamespace:Oa,mpTypeNamespace:_a,pluginProcessFileTypes:Ea}=K,{writeLastLine:Ca}=Y,{runPlugins:Aa}=Me;h.default.task("watch:mainWeixinMp",(function(){const e=ja[Oa.mainMpPath],t=e+"/"+ja.subPackagePath,a=[],n=[],r=new Set,s=new Set;Object.keys(_a).forEach(t=>{a.push(`${e}/**/*.${_a[t].css}`),n.push(`${e}/**/*.${_a[t].html}`),r.add("."+_a[t].css),s.add("."+_a[t].html)});const i=ba.filter([e+"/app.js"],{restore:!0}),p=(ba.filter([e+"/**/*.js"],{restore:!0}),ba.filter([...n],{restore:!0})),o=ba.filter([...a],{restore:!0}),c=ba.filter(Ea.map(t=>`${e}/**/*.${t}`),{restore:!0});return h.default.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Oa.html}___jb_tmp___`,"!"+e+`/**/*.${Oa.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+t+"/**/*"],{base:m.default.resolve(va,e),allowEmpty:!0,cwd:va}).pipe(ba.if("dev"===wa,ba.watch([e+"/**/*","!/"+e+"/app.json","!/"+t+"/**/*"],{cwd:va},(function(e){e.relative.match(/.json/),Ca("处理"+e.relative+"......")})))).pipe(ba.filter((function(t){if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");r.has(t.extname)&&(a=a.replace(n,"."+Oa.css)),s.has(t.extname)&&(a=a.replace(n,"."+Oa.html)),d.default.sync([a.replace(m.default.resolve(va,e),m.default.resolve(va,ya))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(ba.replace(/[\s\S]*/,(function(e){if(Sa.mode||$a.plugin)return e;let t=`./${ja.subPackagePath}/`,a="app.js";return ka===xa&&(a="uni-bootstrap.js"),e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}${a}');\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(p).pipe(ba.rename((function(e){e.extname="."+Oa.html}))).pipe(p.restore).pipe(o).pipe(ba.rename((function(e){e.extname="."+Oa.css}))).pipe(o.restore).pipe(c).pipe(ba.replace(/[\s\S]*/,Aa(m.default.resolve(va,ya+($a.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(c.restore).pipe(h.default.dest(ya+($a.plugin?"/miniprogram":""),{cwd:va}))}));var Na={fakeUniBootstrap:function(e,t,a,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),globalObject.onAppHide&&globalObject.onAppShow||(a="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==a||globalObject.onAppRoute||(a="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var r=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?r.__packInit[s]=e[s]:function(t){r.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==a){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==a&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(n){if("top"===a)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,n);var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===a&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===a&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(n){if("top"!==a){var r=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var a=getCurrentPages(),n=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const{basePath:Ma,targetPath:Ra,subModePath:Ta,currentNamespace:La}=K;var Ba=function(e){const t=m.default.resolve(Ra,"app.js"),a=m.default.resolve(Ra,"app."+La.css),n=e.path.replace(Ma,Ta);return t===n||a===n};const qa=v.default(),{regExpWxResources:Ja,regExpUniRequire:Fa}=K,{getLevelPath:Wa,getLevel:Ia}=Y;var Ua={uniRequireWxResource:function(){return qa.replace(/[\s\S]*/,(function(e,t){const a=["var __uniPackNativeRequireInject={};\n"],n=Ia(this.file.relative);return e=e.replace(Fa,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(Ja,Wa(n))})`);const r=t.replace(Ja,Wa(n)),s=`__uniPackNativeRequireInject[${r}] = require(${r});\n`;return 0>a.indexOf(s)&&a.push(s),`__uniPackNativeRequireInject[${r}]`}),a[1]?`${a.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:Ka,regExpWxResources:Da,wxResourceAlias:Ha}=K,{getLevelPath:Ya,getLevel:za}=Y;var Va=function(e,t){const a=za(t);return"@import "+`"${Ha}/common/main.${Ka.css}";`.replace(Da,Ya(a))+("\n"+e)};const Za=v.default(),{fakeUniBootstrapName:Ga,fakeUniBootstrap:Qa}=Na,{cwd:Xa,env:en,program:tn,basePath:an,targetPath:nn,subModePath:rn,base:sn,regExpUniRequire:pn,regExpWxResources:on,regExpUniImportWxss:cn,currentNamespace:ln,mpTypeNamespace:un,pluginProcessFileTypes:fn,sourceCodePath:gn,projectToSubPackageConfig:dn}=K,hn=process.env.PACK_TYPE,{writeLastLine:mn,getLevel:Pn,getLevelPath:bn,deepFind:vn}=Y,{uniRequireWxResource:yn}=Ua,{runPlugins:wn}=Me,jn=Object.keys(un).map(e=>un[e].css),kn=new Set(jn);h.default.task("subMode:createUniSubPackage",(function(){j.default.mkdirsSync(an);const e=Za.filter(sn+"/**/*.js",{restore:!0}),t=Za.filter([sn+"/common/vendor.js"],{restore:!0}),a=Za.filter([sn+"/common/main.js"],{restore:!0}),n=Za.filter(fn.map(e=>`${sn}/**/*.${e}`),{restore:!0}),r=Za.filter([sn+"/**/*.js","!"+sn+"/app.js","!"+sn+"/uni-bootstrap.js","!"+sn+"/common/vendor.js","!"+sn+"/common/main.js","!"+sn+"/common/runtime.js"],{restore:!0}),s=Za.filter([`${sn}/**/*.${ln.css}`,`!${sn}/app.${ln.css}`,`!${sn}/common/main.${ln.css}`],{restore:!0}),i=Za.filter([`${sn}/**/*.${ln.css}`,`!${sn}/app.${ln.css}`],{restore:!0}),p=Za.filter([sn+"/**/*.json"],{restore:!0}),o=Za.filter([`${sn}/**/*.${ln.html}`],{restore:!0});return h.default.src([sn+"/**","!"+sn+"/app.json",sn+"/app.js",`${sn}/app.${ln.css}`],{allowEmpty:!0,cwd:Xa}).pipe(Za.if("dev"===en,Za.watch([sn+"/**/*","!/"+sn+"/app.json"],{cwd:Xa},(function(e){mn("处理"+e.relative+"......")})))).pipe(Za.filter((function(e){if(function(e){if(0>["ext.json",ln.projectConfig].indexOf(e.relative))return!1;if(dn.mergePack&&""===dn.subPackagePath){if(j.default.existsSync(m.default.resolve(Xa,dn[ln.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");kn.has(e.extname.substr(1))&&(t=t.replace(a,"."+ln.css)),d.default.sync([t.replace(an,m.default.resolve(Xa,rn))],{force:!0})}catch(e){}return!1}return!Ba(e)||".js"===e.extname&&(e.basename="uni-bootstrap.js",!0)}))).pipe(o).pipe(Za.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(ln.html+"$","i"),ln.css),a=this.file.relative.replace(RegExp(ln.html+"$","i"),ln.css);j.default.existsSync(t)||j.default.outputFileSync(m.default.resolve(Xa,rn,a),Va("",a));const n=new te(e);let r=0;return vn(n.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(pn,(t,a,n,s)=>{const i=Pn(this.file.relative),p=a.replace(on,bn(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],r=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),r?n.render():e}),{skipBinary:!1})).pipe(o.restore).pipe(t).pipe(Za.replace(/^/,(function(e){return tn.plugin?`var App=function(packInit){};${ln.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${Ga}=${(""+Qa).replace(/globalObject/g,ln.globalObject)};${Ga}(packInit,__packConfig.packPath,__packConfig.appMode,'${hn}');};`}),{skipBinary:!1})).pipe(t.restore).pipe(e).pipe(S.default()).pipe(yn()).pipe(e.restore).pipe(a).pipe(Za.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(Za.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(a.restore).pipe(r).pipe(Za.replace(/^/,(function(e){if(j.default.existsSync(m.default.resolve(Xa,gn,this.file.relative)))return e;let t=bn(Pn(this.file.relative)),a="app.js";return rn===nn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(r.restore).pipe(p).pipe(Za.replace(/[\s\S]*/,(function(e){if(!j.default.existsSync(m.default.resolve(Xa,gn,this.file.relative.replace(/json$/,"vue")))&&!j.default.existsSync(m.default.resolve(Xa,gn,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=bn(Pn(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(p.restore).pipe(i).pipe(Za.stripCssComments()).pipe(Za.replace(cn,(function(e,t,a){let n="",r=Pn(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const a=RegExp(`(${jn.join("|")})(['"])$`);t=t.replace(a,ln.css+"$2"),n+=`@import ${t.replace(on,bn(r))};\n`})),t+n}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(Za.stripCssComments()).pipe(Za.replace(/^[\s\S]*$/,(function(e){return rn===nn?e:Va(e,this.file.relative)}),{skipBinary:!1})).pipe(s.restore).pipe(n).pipe(Za.replace(/[\s\S]*/,wn(rn),{skipBinary:!1})).pipe(n.restore).pipe(h.default.dest(rn,{cwd:Xa}))}));const xn=v.default(),{cwd:$n,env:Sn,targetPath:On,subModePath:_n,regExpWxResources:En,regExpUniImportWxss:Cn,wxResourcePath:An,currentNamespace:Nn,mpTypeNamespace:Mn,pluginProcessFileTypes:Rn,projectToSubPackageConfig:Tn}=K,{writeLastLine:Ln,getLevel:Bn,getLevelPath:qn}=Y,{uniRequireWxResource:Jn}=Ua,{runPlugins:Fn}=Me,Wn=[],In=[],Un=[],Kn=new Set,Dn=new Set;Object.keys(Mn).forEach(e=>{Wn.push(Mn[e].css),In.push(`${An}/**/*.${Mn[e].css}`),Un.push(`${An}/**/*.${Mn[e].html}`),Kn.add("."+Mn[e].css),Dn.add("."+Mn[e].html)}),h.default.task("subMode:copyWxResource",(function(){const e=Tn[Nn.mainMpPath],t=xn.filter([An+"/**/*.js"],{restore:!0}),a=xn.filter([...In],{restore:!0}),n=xn.filter([...Un],{restore:!0}),r=xn.filter(Rn.map(e=>`${An}/**/*${e}`),{restore:!0});return h.default.src([An+"/**",An,`!${e}/app.json`],{allowEmpty:!0,cwd:$n}).pipe(xn.if("dev"===Sn,xn.watch([An+"/**",An,`!/${e}/app.json`,`!/${An}/**/*.*___jb_tmp___`],{cwd:$n},(function(e){Ln("处理"+e.relative+"......")})))).pipe(t).pipe(xn.replace(/^/,(function(e){let t=qn(Bn(this.file.relative)),a="app.js";return _n===On&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(S.default()).pipe(Jn()).pipe(t.restore).pipe(a).pipe(xn.stripCssComments()).pipe(xn.replace(Cn,(function(e,t,a){let n="";Bn(this.file.relative);return t+n}),{skipBinary:!1})).pipe(xn.replace(/^[\s\S]*$/,(function(e){return _n===On?e:Va(e,this.file.relative)}),{skipBinary:!1})).pipe(xn.rename((function(e){e.extname="."+Nn.css}))).pipe(a.restore).pipe(n).pipe(xn.rename((function(e){e.extname="."+Nn.html}))).pipe(n.restore).pipe(xn.filter((function(e){if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");Kn.has(e.extname)&&(t=t.replace(a,"."+Nn.css)),Dn.has(e.extname)&&(t=t.replace(a,"."+Nn.html)),d.default.sync([t.replace(m.default.resolve($n,An),m.default.resolve($n,_n))],{force:!0})}catch(e){}return!1}return!0}))).pipe(r).pipe(xn.replace(/[\s\S]*/,Fn(_n),{skipBinary:!1})).pipe(r.restore).pipe(h.default.dest(_n,{cwd:$n}))}));const Hn=v.default(),{cwd:Yn,target:zn,env:Vn,projectToSubPackageConfig:Zn,currentNamespace:Gn,mpTypeNamespace:Qn,pluginProcessFileTypes:Xn}=K,{writeLastLine:er}=Y,{runPlugins:tr}=Me;h.default.task("watch:native",(function(){const e=Zn[Gn.mainMpPath],t=[],a=[],n=new Set,r=new Set;Object.keys(Qn).forEach(s=>{t.push(`${e}/**/*.${Qn[s].css}`),a.push(`${e}/**/*.${Qn[s].html}`),n.add("."+Qn[s].css),r.add("."+Qn[s].html)});Hn.filter([e+"/**/*.js"],{restore:!0});const s=Hn.filter([...a],{restore:!0}),i=Hn.filter([...t],{restore:!0}),p=Hn.filter(Xn.map(t=>`${e}/**/*.${t}`),{restore:!0});return h.default.src([e+"/**/*","!"+e+"/app.json"],{base:m.default.resolve(Yn,e),allowEmpty:!0,cwd:Yn}).pipe(Hn.if("dev"===Vn,Hn.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:Yn},(function(e){er("处理"+e.relative+"......")})))).pipe(Hn.filter((function(t){if("unlink"===t.event){try{let a=t.path;const s=RegExp(t.extname+"$","i");n.has(t.extname)&&(a=a.replace(s,"."+Gn.css)),r.has(t.extname)&&(a=a.replace(s,"."+Gn.html)),d.default.sync([a.replace(m.default.resolve(Yn,e),m.default.resolve(Yn,zn))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(s).pipe(Hn.rename((function(e){e.extname="."+Gn.html}))).pipe(s.restore).pipe(i).pipe(Hn.rename((function(e){e.extname="."+Gn.css}))).pipe(i.restore).pipe(p).pipe(Hn.replace(/[\s\S]*/,tr(m.default.resolve(Yn,zn)),{skipBinary:!1})).pipe(p.restore).pipe(h.default.dest(zn,{cwd:Yn}))}));const{cwd:ar,env:nr,targetPath:rr,subModePath:sr,projectToSubPackageConfig:ir,program:pr,currentNamespace:or}=K,{tryAgain:cr}=Y;async function lr(e){let t=m.default.resolve(ar,ir[or.mainMpPath],"app.js");await j.default.exists(t)||await j.default.outputFile(t,"App({});"),e()}h.default.task("mpWxSubMode",h.default.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(pr.plugin||pr.native)t();else{try{let e={packPath:(ir.subPackagePath?"/":"")+ir.subPackagePath,appMode:ir.appMode};await j.default.outputFile(sr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await cr(async()=>{await e(t)})}t()}}),function(){let e=[lr,"subMode:createUniSubPackage","subMode:copyWxResource",...pr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...ir.mergePack?["watch:mainWeixinMpPackPath"]:[],...sr===rr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return pr.native&&(e=[lr,"watch:mainAppJson","watch:native"]),"build"===nr?h.default.series.apply(this,e):h.default.parallel.apply(this,e)}(),(function(e){e(),"build"===nr&&process.exit()})));const{cwd:ur,basePath:fr,base:gr,program:dr}=K;h.default.task("startToPackServe",h.default.series((async function(e){dr.native||await j.default.exists(fr)||await j.default.mkdirs(fr),e()}),"clean:base",(function(e){dr.native?e():h.default.watch(gr+"/app.json",{events:["all"],cwd:ur},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
