"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("del"),t=require("gulp"),a=require("path"),n=require("commander"),r=require("single-line-log"),s=require("gulp-load-plugins"),i=require("vue-template-compiler"),p=require("preprocess"),o=require("shorthash2"),c=require("acorn-globals"),l=require("escodegen"),u=require("getmac"),f=require("fs-extra"),g=require("chokidar"),d=require("strip-json-comments"),h=require("vinyl"),m=require("gulp-strip-comments");function P(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var b=P(e),v=P(t),y=P(a),w=P(n),j=P(r),k=P(s),x=P(i),$=P(p),S=P(o),_=P(c),O=P(l),E=P(u),C=P(f),A=P(g),M=P(d),N=P(h),R=P(m);const{program:T}=w.default;T.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),T.parse(process.argv);const L={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json",pluginConfig:"plugin.json"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json",pluginConfig:"plugin.json"}},q=L[T.type];if(!q)throw Error("小程序类型错");process.env.PACK_TYPE=T.type;const B=T.scope,F=function(e){return require.apply(null,arguments)}(y.default.resolve(B,"./projectToSubPackageConfig")),J=F.sourceCodePath||"src",W=F.wxResourcePath||`${J}/${q.globalObject}resource`,I=F.wxResourceAlias||"@wxResource",U=RegExp(I+"\\/","g"),D=F.uniRequireApiName||"__uniRequireWx",K=RegExp(D+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),H=F.uniImportWxssApiName||"__uniWxss",Y=RegExp(`(}|^|\\s|;)${H}\\s*{([^{}]+)}`,"g"),V=F.projectConfigPath||"";let z="dev";"production"===process.env.NODE_ENV&&(z="build");const Z="dist/"+z+"/mp-"+T.type;let G="dist/"+z+`/mp-${T.type}-pack`;T.plugin&&(G="dist/"+z+`/mp-${T.type}-pack-plugin`);var Q={pluginProcessFileTypes:F.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:q,program:T,cwd:B,projectToSubPackageConfig:F,wxResourcePath:W,wxResourceAlias:I,regExpWxResources:U,uniRequireApiName:D,regExpUniRequire:K,uniImportWxssApiName:H,regExpUniImportWxss:Y,configWxResourceKey:F.configWxResourceKey||"wxResource",env:z,base:Z,target:G,basePath:y.default.resolve(B,Z),subModePath:y.default.resolve(B,G,F.subPackagePath),targetPath:y.default.resolve(B,G),packIsSubpackage:{mode:!1},mpTypeNamespace:L,sourceCodePath:J,projectConfigPath:V};let X;const ee=j.default.stdout;var te={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){ee(e),clearTimeout(X),X=setTimeout(()=>{ee("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,a,n,r){a&&(a(t,n,r),t.childNodes?t.childNodes.forEach((t,n,r)=>{e(t,a,n,r)}):t.children&&t.children.forEach((t,n,r)=>{e(t,a,n,r)}))}};const{basePath:ae}=Q,{tryAgain:ne}=te;v.default.task("clean:base",(async function e(t){try{await b.default([ae+"/**/*"],{force:!0})}catch(a){return void await ne(async()=>{await e(t)})}t()}));const{subModePath:re}=Q,{tryAgain:se}=te;v.default.task("clean:subModePath",(async function e(t){try{await b.default([re+"/**/*"],{force:!0})}catch(a){return void await se(async()=>{await e(t)})}t()}));const{targetPath:ie}=Q,{tryAgain:pe}=te;v.default.task("clean:previewDist",(async function e(t){try{await b.default([ie+"/**/*"],{force:!0})}catch(a){return void await pe(async()=>{await e(t)})}t()}));const{compile:oe}=x.default;var ce=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=oe(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,a){if(!e.attrsMap)return"";e.attrsMap[t]=a}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:a,attrsMap:n,children:r=[]}=t;return e+=this.writeOpenTag(a,n),e+=this.render(r),e+=this.writeCloseTag(a)},t)}writeOpenTag(e,t){if(t){const a=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${a.length>0?" "+a.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:le,mpTypeNamespace:ue}=Q,{deepFind:fe}=te,ge=Object.keys(ue).map(e=>ue[e].directivePrefix),de=Object.keys(ue).map(e=>ue[e].html),he=RegExp(`^(${ge.join("|")})`),me=RegExp(`\\.(${de.join("|")})$`,"i");var Pe=function(e,t){if(t.relative.match(me)){const t=new ce(e);return fe(t.topNode,e=>{if(!e.tag||3===e.type)return;const a=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&a&&!a.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",a+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const r=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&r&&t.setAttr(e,"src",r.replace(me,"."+le.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(he)){const a=t.replace(he,le.directivePrefix);e.attrsMap[a]=e.attrsMap[t],a!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:be,mpTypeNamespace:ve}=Q,ye=Object.keys(ve).map(e=>ve[e].css),we=RegExp(`\\.(${ye.join("|")})$`,"i");var je=function(e,{relative:t}){return t.match(we)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(we,"."+be.css)}'`}))),e};var ke=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:xe}=$.default;var $e=function(e,{relative:t}){if(t.match(/\.js$/i))try{return xe(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:Se}=Q,{preprocess:_e}=$.default;var Oe=function(e,{relative:t}){if(t.match(RegExp(`.${Se.css}$`,"i")))try{return _e(e,process.env,{type:"css"})}catch(t){return console.log(Se.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:Ee}=Q,{preprocess:Ce}=$.default;var Ae=function(e,{relative:t}){if(t.match(RegExp(`.${Ee.html}$`,"i")))try{return Ce(e,process.env,{type:"html"})}catch(t){return console.log(Ee.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:Me,currentNamespace:Ne}=Q,Re=(process,new Set(Object.keys(Me).map(e=>Me[e].globalObject)));var Te={mixinsEnvCode:function(e){let t="";return Re.forEach(e=>{Ne.globalObject!==e&&(t+=`var ${e} = ${Ne.globalObject};\n`)}),t}};const{mixinsEnvCode:Le}=Te;var qe=function(e,{relative:t}){return t.match(/\.js$/i)?Le()+e:e};const{projectToSubPackageConfig:Be,basePath:Fe}=Q;const Je=S.default(Be.subPackagePath+(0,E.default)()+Math.random()+Date.now()),We={library:`webpackJsonp_${Be.subPackagePath}_${Je}`,reference:"webpackJsonp"};var Ie={htmlMixinPlugin:Pe,cssMixinPlugin:je,polyfillPlugin:ke,jsPreProcessPlugin:$e,cssPreProcessPlugin:Oe,htmlPreProcessPlugin:Ae,jsMixinPlugin:qe,setLibrary:function(e,{fromAbsolute:t},a,n={}){n={...We,...n};let r=!1;if(t.startsWith(Fe)&&".js"===y.default.extname(t)){const t=_.default.parse(e),a=_.default(t);for(const{name:e,nodes:t}of a)if("global"===e)for(const{parents:e}of t)for(const t of e){const{type:e,property:{type:a,value:s}={}}=t;"MemberExpression"===e&&"Literal"===a&&s===n.reference&&(t.property.value=n.library,r=!0)}if(r){const e="production"===process.env.NODE_ENV?O.default.FORMAT_MINIFY:O.default.FORMAT_DEFAULTS;return O.default.generate(t,{format:e})}}return e}};const{projectToSubPackageConfig:Ue,targetPath:De}=Q,Ke=y.default;(!Ue.plugins||!Ue.plugins instanceof Array)&&(Ue.plugins=[]);var He={runPlugins:function(e){return function(t){const{plugins:a}=Ue;if(a&&!(!a instanceof Array))return a.reduce((t,a)=>{if("string"==typeof a&&(a=Ie[a]),"function"!=typeof a)return t;const n=Ke.resolve(e,this.file.relative),r={relative:n.replace(RegExp("^"+De.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:n,fromAbsolute:this.file.path,fromRelative:this.file.relative};this.removeAfterAdd=function(e){!function(e){C.default.existsSync(e)&&C.default.removeSync(e);const t=A.default.watch(e);t.on("add",(function(){C.default.removeSync(e),t.close()}))}(e=e||n)};const s=a.call(this,t,r,Ie);return null==s?t:s},t)}}};const Ye=k.default(),{cwd:Ve,projectToSubPackageConfig:{subPackagePath:ze},target:Ze,env:Ge,pluginProcessFileTypes:Qe,sourceCodePath:Xe,currentNamespace:{pluginConfig:et}}=Q,{writeLastLine:tt}=te,{runPlugins:at}=He;v.default.task("watch:pluginJson",(function(){const e=Ye.filter(Qe.map(e=>"**/*."+e),{restore:!0}),t=`${Xe}/${et}`;return v.default.src(t,{allowEmpty:!0,cwd:Ve}).pipe(Ye.if("dev"===Ge,Ye.watch(t,{cwd:Ve},(function(e){tt("处理"+e.relative+"......")})))).pipe(e).pipe(Ye.replace(/[\s\S]*/,at(y.default.resolve(Ve,Ze+"/"+ze)),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Ze+"/"+ze,{cwd:Ve}))}));const nt=k.default(),{cwd:rt,target:st,env:it,targetPath:pt,pluginProcessFileTypes:ot,currentNamespace:ct,projectConfigPath:lt}=Q,{writeLastLine:ut}=te,{runPlugins:ft}=He;v.default.task("watch:projectConfigJson",(function(){const e=nt.filter(ot.map(e=>"**/*."+e),{restore:!0});return v.default.src(`${lt?lt+"/":""}${ct.projectConfig}`,{allowEmpty:!0,cwd:rt}).pipe(nt.if("dev"===it,nt.watch(`${lt?lt+"/":""}${ct.projectConfig}`,{cwd:rt},(function(e){ut("处理"+e.relative+"......")})))).pipe(e).pipe(nt.replace(/[\s\S]*/,ft(pt),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(st,{cwd:rt}))}));const{runPlugins:gt}=He,{program:dt,cwd:ht,projectToSubPackageConfig:mt,subModePath:Pt,targetPath:bt,packIsSubpackage:vt,currentNamespace:yt,target:wt}=Q;var jt=function(){if(dt.plugin)return;const e=y.default.resolve(ht,mt[yt.mainMpPath]+"/app.js");if(C.default.existsSync(e)){const t=C.default.readFileSync(e,"utf8");let a=`./${mt.subPackagePath}/`,n="app.js";Pt===bt&&(n="uni-bootstrap.js");let r=`require('${a}${n}');\n`;(vt.mode||dt.plugin)&&(r="");const s=new N.default({cwd:ht,base:y.default.resolve(ht,mt[yt.mainMpPath]),path:e});C.default.outputFileSync(bt+"/"+s.relative,gt(y.default.resolve(ht,wt+(dt.plugin?"/miniprogram":""))).call({file:s},r+t))}};const kt=k.default(),{program:xt,cwd:$t,projectToSubPackageConfig:St,configWxResourceKey:_t,base:Ot,packIsSubpackage:Et,currentNamespace:Ct,sourceCodePath:At}=Q,{writeLastLine:Mt}=te;var Nt=function(e){return Mt("处理app.json......"),kt.replace(/[\s\S]+/,(function(t){if(xt.plugin&&"mainAppJson"===e)return t;Et.mode=!1;let a,n,r,s={};({pagesJson(){try{a=JSON.parse(M.default(t))}catch(e){a={}}},baseAppJson(){try{n=JSON.parse(t)}catch(e){n={}}},mainAppJson(){try{r=JSON.parse(t)}catch(e){r={}}}})[e]();try{a||(a=JSON.parse(M.default(C.default.readFileSync(y.default.resolve($t,At+"/pages.json"),"utf8"))))}catch(e){a={}}try{n||(n=JSON.parse(C.default.readFileSync(y.default.resolve($t,Ot+"/app.json"),"utf8")))}catch(e){n={}}try{r||(r=JSON.parse(C.default.readFileSync(y.default.resolve($t,St[Ct.mainMpPath]+"/app.json"),"utf8")))}catch(e){r={}}function i(e){return St.subPackagePath+(St.subPackagePath?"/":"")+e}if(r.subpackages&&!r.subPackages&&(r.subPackages=r.subpackages),r.subPackages){let e=r.subPackages.find(e=>e.root===St.subPackagePath);if(e){Et.mode=!0;let t=[...a[_t]&&a[_t].pages||[],...n.pages||[]];return n.subPackages&&n.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[_t]&&a[_t].subPackages&&a[_t].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,jt.call(this),delete n.pages,delete n.subPackages,JSON.stringify({...n,...r},null,2)}}n.pages&&n.pages.forEach((e,t)=>{n.pages[t]=i(e)}),n.subPackages&&n.subPackages.forEach(e=>{e.root=i(e.root)}),a[_t]&&(a[_t].pages&&a[_t].pages.forEach((e,t)=>{a[_t].pages[t]=i(e)}),a[_t].subPackages&&a[_t].subPackages.forEach(e=>{e.root=i(e.root)})),n.tabBar&&n.tabBar.list&&n.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...r},s)=>{n.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:a?i(a):"",...r}}),s={...n,...r},s.pages=Array.from(new Set([...a.indexPage?[i(a.indexPage)]:[],...r.pages||[],...n.pages||[],...a[_t]&&a[_t].pages||[]]));let p=[],o={},c={};function l(e){e.forEach(e=>{o[e.root]=o[e.root]?Array.from(new Set([...o[e.root],...e.pages])):e.pages,e.name&&(c[e.root]=e.name)})}l(a[_t]&&a[_t].subPackages||[]),l(n.subPackages||[]),l(r.subPackages||[]);for(let e in o){const t={root:e,pages:o[e]};c[e]&&(t.name=c[e]),p.push(t)}if(s.subPackages=[...p],n.usingComponents){for(let e in n.usingComponents)n.usingComponents[e]="/"+St.subPackagePath+n.usingComponents[e];s.usingComponents={...s.usingComponents||{},...n.usingComponents}}return jt.call(this),"toutiao"===xt.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const Rt=k.default(),{cwd:Tt,target:Lt,env:qt,targetPath:Bt,pluginProcessFileTypes:Ft,sourceCodePath:Jt}=Q,{writeLastLine:Wt}=te,{runPlugins:It}=He;v.default.task("watch:pagesJson",(function(){const e=Rt.filter(Ft.map(e=>"**/*."+e),{restore:!0});return v.default.src(Jt+"/pages.json",{allowEmpty:!0,cwd:Tt}).pipe(Rt.if("dev"===qt,Rt.watch(Jt+"/pages.json",{cwd:Tt},(function(e){Wt("处理"+e.relative+"......")})))).pipe(Nt("pagesJson")).pipe(Rt.rename("app.json")).pipe(e).pipe(Rt.replace(/[\s\S]*/,It(Bt),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Lt,{cwd:Tt}))}));const Ut=k.default(),{cwd:Dt,target:Kt,env:Ht,base:Yt,targetPath:Vt,pluginProcessFileTypes:zt}=Q,{writeLastLine:Zt}=te,{runPlugins:Gt}=He;v.default.task("watch:baseAppJson",(function(){const e=Ut.filter(zt.map(e=>`${Yt}/**/*.${e}`),{restore:!0});return v.default.src(Yt+"/app.json",{allowEmpty:!0,cwd:Dt}).pipe(Ut.if("dev"===Ht,Ut.watch(Yt+"/app.json",{cwd:Dt},(function(e){Zt("处理"+e.relative+"......")})))).pipe(Nt("baseAppJson")).pipe(e).pipe(Ut.replace(/[\s\S]*/,Gt(Vt),{skipBinary:!1})).pipe(e.restore).pipe(v.default.dest(Kt,{cwd:Dt}))}));const Qt=k.default(),{cwd:Xt,target:ea,env:ta,projectToSubPackageConfig:aa,program:na,currentNamespace:ra,pluginProcessFileTypes:sa}=Q,{writeLastLine:ia}=te,{runPlugins:pa}=He;v.default.task("watch:mainAppJson",(function(){const e=aa[ra.mainMpPath],t=Qt.filter(sa.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src(e+"/app.json",{allowEmpty:!0,cwd:Xt}).pipe(Qt.if("dev"===ta,Qt.watch(e+"/app.json",{cwd:Xt},(function(e){ia("处理"+e.relative+"......")})))).pipe(Nt("mainAppJson")).pipe(t).pipe(Qt.replace(/[\s\S]*/,pa(y.default.resolve(Xt,ea+(na.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(v.default.dest(ea+(na.plugin?"/miniprogram":""),{cwd:Xt}))}));const oa=k.default(),{cwd:ca,target:la,env:ua,projectToSubPackageConfig:fa,program:ga,basePath:da,currentNamespace:ha,mpTypeNamespace:ma,pluginProcessFileTypes:Pa}=Q,{writeLastLine:ba}=te,{runPlugins:va}=He;v.default.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=fa[ha.mainMpPath];const t=Object.keys(ma).map(t=>`${e}/app.${ma[t].css}`),a=oa.filter([...t],{restore:!0}),n=oa.filter([e+"/app.js"],{restore:!0}),r=oa.filter(Pa.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/app.js",...t],{allowEmpty:!0,cwd:ca}).pipe(oa.if("dev"===ua,oa.watch([e+"/app.js",`${e}/app.${ha.css}`],{cwd:ca},(function(e){ba("处理"+e.relative+"......")})))).pipe(n).pipe(oa.replace(/^/,(function(e){return"require('./uni-bootstrap.js');\n"}),{skipBinary:!1})).pipe(n.restore).pipe(a).pipe(oa.replace(/^/,(function(e){return C.default.readFileSync(`${da}/app.${ha.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(oa.rename((function(e){e.extname="."+ha.css}))).pipe(a.restore).pipe(r).pipe(oa.replace(/[\s\S]*/,va(y.default.resolve(ca,la+(ga.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(r.restore).pipe(v.default.dest(la+(ga.plugin?"/miniprogram":""),{cwd:ca}))}));const ya=k.default(),{cwd:wa,target:ja,env:ka,projectToSubPackageConfig:xa,base:$a,wxResourcePath:Sa,currentNamespace:_a,mpTypeNamespace:Oa,pluginProcessFileTypes:Ea}=Q,{writeLastLine:Ca}=te,{runPlugins:Aa}=He;v.default.task("watch:mainWeixinMpPackPath",(function(){const e=xa[_a.mainMpPath],t=e+"/"+xa.subPackagePath,a=ja+"/"+xa.subPackagePath,n=[],r=[],s=new Set,i=new Set;Object.keys(Oa).forEach(e=>{n.push(`${t}/**/*.${Oa[e].css}`),r.push(`${t}/**/*.${Oa[e].html}`),s.add("."+Oa[e].css),i.add("."+Oa[e].html)});const p=ya.filter([...r],{restore:!0}),o=ya.filter([...n],{restore:!0}),c=(ya.filter([t+"/**/*.js"],{restore:!0}),ya.filter(Ea.map(e=>`${t}/**/*.${e}`),{restore:!0}));return v.default.src([t,t+"/**/*","!"+t+"/pack.config.js"],{allowEmpty:!0,cwd:wa}).pipe(ya.if("dev"===ka,ya.watch([t,t+"/**/*","!/"+t+"/pack.config.js"],{cwd:wa},(function(e){Ca("处理"+e.relative+"......")})))).pipe(ya.filter((function(t){if(t.relative!==_a.projectConfig&&!function(e){const t=xa[_a.mainMpPath]+"/"+xa.subPackagePath;return C.default.existsSync(e.path.replace(y.default.resolve(wa,t),y.default.resolve(wa,$a)))?["ext.json",_a.projectConfig].indexOf(e.relative)>-1&&xa.mergePack&&""===xa.subPackagePath:!C.default.existsSync(e.path.replace(y.default.resolve(wa,t),y.default.resolve(wa,Sa)))}(t))return!1;if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");s.has(t.extname)&&(a=a.replace(n,"."+_a.css)),i.has(t.extname)&&(a=a.replace(n,"."+_a.html)),b.default.sync([a.replace(y.default.resolve(wa,e),y.default.resolve(wa,ja))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(ya.rename((function(e){e.extname="."+_a.html}))).pipe(p.restore).pipe(o).pipe(ya.rename((function(e){e.extname="."+_a.css}))).pipe(o.restore).pipe(c).pipe(ya.replace(/[\s\S]*/,Aa(y.default.resolve(wa,a)),{skipBinary:!1})).pipe(c.restore).pipe(v.default.dest(a,{cwd:wa}))}));const Ma=k.default(),{cwd:Na,target:Ra,env:Ta,projectToSubPackageConfig:La,subModePath:qa,targetPath:Ba,program:Fa,packIsSubpackage:Ja,currentNamespace:Wa,mpTypeNamespace:Ia,pluginProcessFileTypes:Ua}=Q,{writeLastLine:Da}=te,{runPlugins:Ka}=He;v.default.task("watch:mainWeixinMp",(function(){const e=La[Wa.mainMpPath],t=e+"/"+La.subPackagePath,a=[],n=[],r=new Set,s=new Set;Object.keys(Ia).forEach(t=>{a.push(`${e}/**/*.${Ia[t].css}`),n.push(`${e}/**/*.${Ia[t].html}`),r.add("."+Ia[t].css),s.add("."+Ia[t].html)});const i=Ma.filter([e+"/app.js"],{restore:!0}),p=(Ma.filter([e+"/**/*.js"],{restore:!0}),Ma.filter([...n],{restore:!0})),o=Ma.filter([...a],{restore:!0}),c=Ma.filter(Ua.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Wa.html}___jb_tmp___`,"!"+e+`/**/*.${Wa.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+t+"/**/*"],{base:y.default.resolve(Na,e),allowEmpty:!0,cwd:Na}).pipe(Ma.if("dev"===Ta,Ma.watch([e+"/**/*","!/"+e+"/app.json","!/"+t+"/**/*"],{cwd:Na},(function(e){e.relative.match(/.json/),Da("处理"+e.relative+"......")})))).pipe(Ma.filter((function(t){if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");r.has(t.extname)&&(a=a.replace(n,"."+Wa.css)),s.has(t.extname)&&(a=a.replace(n,"."+Wa.html)),b.default.sync([a.replace(y.default.resolve(Na,e),y.default.resolve(Na,Ra))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(Ma.replace(/[\s\S]*/,(function(e){if(Ja.mode||Fa.plugin)return e;let t=`./${La.subPackagePath}/`,a="app.js";return qa===Ba&&(a="uni-bootstrap.js"),e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}${a}');\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(p).pipe(Ma.rename((function(e){e.extname="."+Wa.html}))).pipe(p.restore).pipe(o).pipe(Ma.rename((function(e){e.extname="."+Wa.css}))).pipe(o.restore).pipe(c).pipe(Ma.replace(/[\s\S]*/,Ka(y.default.resolve(Na,Ra+(Fa.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(c.restore).pipe(v.default.dest(Ra+(Fa.plugin?"/miniprogram":""),{cwd:Na}))}));var Ha={fakeUniBootstrap:function(e,t,a,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),globalObject.onAppHide&&globalObject.onAppShow||(a="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==a||globalObject.onAppRoute||(a="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var r=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?r.__packInit[s]=e[s]:function(t){r.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==a){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==a&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(n){if("top"===a)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,n);var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===a&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===a&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(n){if("top"!==a){var r=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var a=getCurrentPages(),n=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const{basePath:Ya,targetPath:Va,subModePath:za,currentNamespace:Za}=Q;var Ga=function(e){const t=y.default.resolve(Va,"app.js"),a=y.default.resolve(Va,"app."+Za.css),n=e.path.replace(Ya,za);return t===n||a===n};const Qa=k.default(),{regExpWxResources:Xa,regExpUniRequire:en}=Q,{getLevelPath:tn,getLevel:an}=te;var nn={uniRequireWxResource:function(){return Qa.replace(/[\s\S]*/,(function(e,t){const a=["var __uniPackNativeRequireInject={};\n"],n=an(this.file.relative);return e=e.replace(en,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(Xa,tn(n))})`);const r=t.replace(Xa,tn(n)),s=`__uniPackNativeRequireInject[${r}] = require(${r});\n`;return 0>a.indexOf(s)&&a.push(s),`__uniPackNativeRequireInject[${r}]`}),a[1]?`${a.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:rn,regExpWxResources:sn,wxResourceAlias:pn}=Q,{getLevelPath:on,getLevel:cn}=te;var ln=function(e,t){const a=cn(t);return"@import "+`"${pn}/app.${rn.css}";`.replace(sn,on(a))+("\n"+e)};const un=k.default(),{fakeUniBootstrapName:fn,fakeUniBootstrap:gn}=Ha,{cwd:dn,env:hn,program:mn,basePath:Pn,targetPath:bn,subModePath:vn,base:yn,regExpUniRequire:wn,regExpWxResources:jn,regExpUniImportWxss:kn,currentNamespace:xn,mpTypeNamespace:$n,pluginProcessFileTypes:Sn,sourceCodePath:_n,projectToSubPackageConfig:On}=Q,En=process.env.PACK_TYPE,{writeLastLine:Cn,getLevel:An,getLevelPath:Mn,deepFind:Nn}=te,{uniRequireWxResource:Rn}=nn,{runPlugins:Tn}=He,Ln=Object.keys($n).map(e=>$n[e].css),qn=new Set(Ln);v.default.task("subMode:createUniSubPackage",(function(){C.default.mkdirsSync(Pn);const e=un.filter(yn+"/**/*.js",{restore:!0}),t=un.filter([yn+"/common/vendor.js"],{restore:!0}),a=un.filter([yn+"/common/main.js"],{restore:!0}),n=un.filter(Sn.map(e=>`${yn}/**/*.${e}`),{restore:!0}),r=un.filter([yn+"/**/*.js","!"+yn+"/app.js","!"+yn+"/uni-bootstrap.js","!"+yn+"/common/vendor.js","!"+yn+"/common/main.js","!"+yn+"/common/runtime.js"],{restore:!0}),s=un.filter([`${yn}/**/*.${xn.css}`,`!${yn}/app.${xn.css}`,`!${yn}/common/main.${xn.css}`],{restore:!0}),i=un.filter([`${yn}/**/*.${xn.css}`,`!${yn}/app.${xn.css}`],{restore:!0}),p=un.filter([yn+"/**/*.json"],{restore:!0}),o=un.filter([`${yn}/**/*.${xn.html}`],{restore:!0});return v.default.src([yn+"/**","!"+yn+"/app.json",yn+"/app.js",`${yn}/app.${xn.css}`],{allowEmpty:!0,cwd:dn}).pipe(un.if("dev"===hn,un.watch([yn+"/**/*","!/"+yn+"/app.json"],{cwd:dn},(function(e){Cn("处理"+e.relative+"......")})))).pipe(un.filter((function(e){if(function(e){if(0>["ext.json",xn.projectConfig].indexOf(e.relative))return!1;if(On.mergePack&&""===On.subPackagePath){if(C.default.existsSync(y.default.resolve(dn,On[xn.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");qn.has(e.extname.substr(1))&&(t=t.replace(a,"."+xn.css)),b.default.sync([t.replace(Pn,y.default.resolve(dn,vn))],{force:!0})}catch(e){}return!1}return!Ga(e)||".js"===e.extname&&(e.basename="uni-bootstrap.js",!0)}))).pipe(o).pipe(un.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(xn.html+"$","i"),xn.css),a=this.file.relative.replace(RegExp(xn.html+"$","i"),xn.css);C.default.existsSync(t)||C.default.outputFileSync(y.default.resolve(dn,vn,a),ln("",a));const n=new ce(e);let r=0;return Nn(n.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(wn,(t,a,n,s)=>{const i=An(this.file.relative),p=a.replace(jn,Mn(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],r=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),r?n.render():e}),{skipBinary:!1})).pipe(o.restore).pipe(t).pipe(un.replace(/^/,(function(e){return mn.plugin?`var App=function(packInit){};${xn.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${fn}=${(""+gn).replace(/globalObject/g,xn.globalObject)};${fn}(packInit,__packConfig.packPath,__packConfig.appMode,'${En}');};`}),{skipBinary:!1})).pipe(t.restore).pipe(e).pipe(R.default()).pipe(Rn()).pipe(e.restore).pipe(a).pipe(un.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(un.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(a.restore).pipe(r).pipe(un.replace(/^/,(function(e){if(C.default.existsSync(y.default.resolve(dn,_n,this.file.relative)))return e;let t=Mn(An(this.file.relative)),a="app.js";return vn===bn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(r.restore).pipe(p).pipe(un.replace(/[\s\S]*/,(function(e){if(!C.default.existsSync(y.default.resolve(dn,_n,this.file.relative.replace(/json$/,"vue")))&&!C.default.existsSync(y.default.resolve(dn,_n,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Mn(An(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(p.restore).pipe(i).pipe(un.stripCssComments()).pipe(un.replace(kn,(function(e,t,a){let n="",r=An(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const a=RegExp(`(${Ln.join("|")})(['"])$`);t=t.replace(a,xn.css+"$2"),n+=`@import ${t.replace(jn,Mn(r))};\n`})),t+n}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(un.stripCssComments()).pipe(un.replace(/^[\s\S]*$/,(function(e){return vn===bn?e:ln(e,this.file.relative)}),{skipBinary:!1})).pipe(s.restore).pipe(n).pipe(un.replace(/[\s\S]*/,Tn(vn),{skipBinary:!1})).pipe(n.restore).pipe(v.default.dest(vn,{cwd:dn}))}));const Bn=k.default(),{cwd:Fn,env:Jn,targetPath:Wn,subModePath:In,regExpWxResources:Un,regExpUniImportWxss:Dn,wxResourcePath:Kn,currentNamespace:Hn,mpTypeNamespace:Yn,pluginProcessFileTypes:Vn,projectToSubPackageConfig:zn}=Q,{writeLastLine:Zn,getLevel:Gn,getLevelPath:Qn}=te,{uniRequireWxResource:Xn}=nn,{runPlugins:er}=He,tr=[],ar=[],nr=[],rr=new Set,sr=new Set;Object.keys(Yn).forEach(e=>{tr.push(Yn[e].css),ar.push(`${Kn}/**/*.${Yn[e].css}`),nr.push(`${Kn}/**/*.${Yn[e].html}`),rr.add("."+Yn[e].css),sr.add("."+Yn[e].html)}),v.default.task("subMode:copyWxResource",(function(){const e=zn[Hn.mainMpPath],t=Bn.filter([Kn+"/**/*.js"],{restore:!0}),a=Bn.filter([...ar],{restore:!0}),n=Bn.filter([...nr],{restore:!0}),r=Bn.filter(Vn.map(e=>`${Kn}/**/*${e}`),{restore:!0});return v.default.src([Kn+"/**",Kn,`!${e}/app.json`],{allowEmpty:!0,cwd:Fn}).pipe(Bn.if("dev"===Jn,Bn.watch([Kn+"/**",Kn,`!/${e}/app.json`,`!/${Kn}/**/*.*___jb_tmp___`],{cwd:Fn},(function(e){Zn("处理"+e.relative+"......")})))).pipe(t).pipe(Bn.replace(/^/,(function(e){let t=Qn(Gn(this.file.relative)),a="app.js";return In===Wn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(R.default()).pipe(Xn()).pipe(t.restore).pipe(a).pipe(Bn.stripCssComments()).pipe(Bn.replace(Dn,(function(e,t,a){let n="";Gn(this.file.relative);return t+n}),{skipBinary:!1})).pipe(Bn.replace(/^[\s\S]*$/,(function(e){return In===Wn?e:ln(e,this.file.relative)}),{skipBinary:!1})).pipe(Bn.rename((function(e){e.extname="."+Hn.css}))).pipe(a.restore).pipe(n).pipe(Bn.rename((function(e){e.extname="."+Hn.html}))).pipe(n.restore).pipe(Bn.filter((function(e){if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");rr.has(e.extname)&&(t=t.replace(a,"."+Hn.css)),sr.has(e.extname)&&(t=t.replace(a,"."+Hn.html)),b.default.sync([t.replace(y.default.resolve(Fn,Kn),y.default.resolve(Fn,In))],{force:!0})}catch(e){}return!1}return!0}))).pipe(r).pipe(Bn.replace(/[\s\S]*/,er(In),{skipBinary:!1})).pipe(r.restore).pipe(v.default.dest(In,{cwd:Fn}))}));const ir=k.default(),{cwd:pr,target:or,env:cr,projectToSubPackageConfig:lr,currentNamespace:ur,mpTypeNamespace:fr,pluginProcessFileTypes:gr}=Q,{writeLastLine:dr}=te,{runPlugins:hr}=He;v.default.task("watch:native",(function(){const e=lr[ur.mainMpPath],t=[],a=[],n=new Set,r=new Set;Object.keys(fr).forEach(s=>{t.push(`${e}/**/*.${fr[s].css}`),a.push(`${e}/**/*.${fr[s].html}`),n.add("."+fr[s].css),r.add("."+fr[s].html)});ir.filter([e+"/**/*.js"],{restore:!0});const s=ir.filter([...a],{restore:!0}),i=ir.filter([...t],{restore:!0}),p=ir.filter(gr.map(t=>`${e}/**/*.${t}`),{restore:!0});return v.default.src([e+"/**/*","!"+e+"/app.json"],{base:y.default.resolve(pr,e),allowEmpty:!0,cwd:pr}).pipe(ir.if("dev"===cr,ir.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:pr},(function(e){dr("处理"+e.relative+"......")})))).pipe(ir.filter((function(t){if("unlink"===t.event){try{let a=t.path;const s=RegExp(t.extname+"$","i");n.has(t.extname)&&(a=a.replace(s,"."+ur.css)),r.has(t.extname)&&(a=a.replace(s,"."+ur.html)),b.default.sync([a.replace(y.default.resolve(pr,e),y.default.resolve(pr,or))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(s).pipe(ir.rename((function(e){e.extname="."+ur.html}))).pipe(s.restore).pipe(i).pipe(ir.rename((function(e){e.extname="."+ur.css}))).pipe(i.restore).pipe(p).pipe(ir.replace(/[\s\S]*/,hr(y.default.resolve(pr,or)),{skipBinary:!1})).pipe(p.restore).pipe(v.default.dest(or,{cwd:pr}))}));const{cwd:mr,env:Pr,targetPath:br,subModePath:vr,projectToSubPackageConfig:yr,program:wr,currentNamespace:jr}=Q,{tryAgain:kr}=te;async function xr(e){let t=y.default.resolve(mr,yr[jr.mainMpPath],"app.js");await C.default.exists(t)||await C.default.outputFile(t,"App({});"),e()}v.default.task("mpWxSubMode",v.default.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(wr.plugin||wr.native)t();else{try{let e={packPath:(yr.subPackagePath?"/":"")+yr.subPackagePath,appMode:yr.appMode};await C.default.outputFile(vr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await kr(async()=>{await e(t)})}t()}}),function(){let e=[xr,"subMode:createUniSubPackage","subMode:copyWxResource",...wr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...yr.mergePack?["watch:mainWeixinMpPackPath"]:[],...vr===br?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return wr.native&&(e=[xr,"watch:mainAppJson","watch:native"]),"build"===Pr?v.default.series.apply(this,e):v.default.parallel.apply(this,e)}(),(function(e){e(),"build"===Pr&&process.exit()})));const{cwd:$r,basePath:Sr,base:_r,program:Or}=Q;v.default.task("startToPackServe",v.default.series((async function(e){Or.native||await C.default.exists(Sr)||await C.default.mkdirs(Sr),e()}),"clean:base",(function(e){Or.native?e():v.default.watch(_r+"/app.json",{events:["all"],cwd:$r},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});exports.default={};
